!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("Bronze",[],t):"object"==typeof exports?exports.Bronze=t():e.Bronze=t()}(window,function(){return n={},r.m=i=[function(e,t,i){"use strict";i.r(t);var n={};i.r(n),i.d(n,"radToDeg",function(){return a}),i.d(n,"degToRad",function(){return u}),i.d(n,"isPowerOf2",function(){return h}),i.d(n,"default",function(){return l});var r={};i.r(r),i.d(r,"Vector3",function(){return g}),i.d(r,"normalize",function(){return d}),i.d(r,"rotationX",function(){return b}),i.d(r,"rotationY",function(){return m}),i.d(r,"rotationZ",function(){return v}),i.d(r,"vecMultiply",function(){return _}),i.d(r,"multiply",function(){return w}),i.d(r,"distance",function(){return y}),i.d(r,"length",function(){return p}),i.d(r,"angleBetweenVectors",function(){return x}),i.d(r,"default",function(){return E});var o={};i.r(o),i.d(o,"Vector2",function(){return A}),i.d(o,"normalize",function(){return P}),i.d(o,"vec2Multiply",function(){return S}),i.d(o,"multiply",function(){return B}),i.d(o,"distance",function(){return k}),i.d(o,"length",function(){return L}),i.d(o,"angleBetweenVectors",function(){return C}),i.d(o,"default",function(){return O});var s={};function a(e){return 180*e/Math.PI}function u(e){return e*Math.PI/180}function h(e){return 0==(e&e-1)}i.r(s),i.d(s,"Matrix4",function(){return j}),i.d(s,"unit",function(){return F}),i.d(s,"perspective",function(){return z}),i.d(s,"projection",function(){return U}),i.d(s,"translation",function(){return D}),i.d(s,"translateX",function(){return G}),i.d(s,"translateY",function(){return N}),i.d(s,"translateZ",function(){return X}),i.d(s,"rotationX",function(){return H}),i.d(s,"rotationY",function(){return Y}),i.d(s,"rotationZ",function(){return V}),i.d(s,"scaling",function(){return W}),i.d(s,"rotation",function(){return q}),i.d(s,"multiply",function(){return Z}),i.d(s,"multiplyScalar",function(){return J}),i.d(s,"multiplyVector4",function(){return K}),i.d(s,"transformVector",function(){return Q}),i.d(s,"inverse",function(){return $}),i.d(s,"transpose",function(){return ee}),i.d(s,"default",function(){return te});var l={radToDeg:a,degToRad:u,isPowerOf2:h};function c(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function f(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var g=function(){function n(e,t,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),f(this,"x",0),f(this,"y",0),f(this,"z",0),this.set(e,t,i)}return function(e,t,i){t&&c(e.prototype,t),i&&c(e,i)}(n,[{key:"set",value:function(e,t,i){this.x=e,this.y=t,this.z=i}},{key:"move",value:function(e,t,i){this.x+=e,this.y+=t,this.z+=i}},{key:"moveArray",value:function(e){this.x+=e[0],this.y+=e[1],this.z+=e[2]}},{key:"scale",value:function(e,t,i){this.x*=e,this.y*=t,this.z*=i}},{key:"toArray",value:function(){return[this.x,this.y,this.z]}},{key:"copy",value:function(){return Object.assign(new n(0,0,0),this)}},{key:"add",value:function(e){this.x+=e.x,this.y+=e.y,this.z+=e.z}},{key:"sub",value:function(e){this.x-=e.x,this.y-=e.y,this.z-=e.z}}]),n}();function d(e){var t=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z);return 1e-5<t?(e.x=e.x/t,e.y=e.y/t,e.z=e.z/t,e):null}function b(e){var t=Math.cos(e),i=Math.sin(e);return[1,0,0,0,t,i,0,-i,t]}function m(e){var t=Math.cos(e),i=Math.sin(e);return[t,0,-i,0,1,0,i,0,t]}function v(e){var t=Math.cos(e),i=Math.sin(e);return[t,i,0,-i,t,0,0,0,1]}function _(e,t){return[e[0]*t.x+e[1]*t.y+e[2]*t.z,e[3]*t.x+e[4]*t.y+e[5]*t.z,e[6]*t.x+e[7]*t.y+e[8]*t.z]}function w(e,t){var i=e[0],n=e[1],r=e[2],o=e[3],s=e[4],a=e[5],u=e[6],h=e[7],l=e[8],c=t[0],f=t[1],g=t[2],d=t[3],b=t[4],m=t[5],v=t[6],_=t[7],w=t[8];return[c*i+f*o+g*u,c*n+f*s+g*h,c*r+f*a+g*l,d*i+b*o+m*u,d*n+b*s+m*h,d*r+b*a+m*l,v*i+_*o+w*u,v*n+_*s+w*h,v*r+_*a+w*l]}function y(e,t){var i=0;return i+=(e.x-t.x)*(e.x-t.x),i+=(e.y-t.y)*(e.y-t.y),i+=(e.z-t.z)*(e.z-t.z),Math.sqrt(i)}function p(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z)}function x(e,t){return(e.x*t.x+e.y*t.y+e.z*t.z)/(p(e)*p(t))}var E={Vector3:g};function T(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function R(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var A=function(){function i(e,t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),R(this,"x",0),R(this,"y",0),this.set(e,t)}return function(e,t,i){t&&T(e.prototype,t),i&&T(e,i)}(i,[{key:"set",value:function(e,t){this.x=e,this.y=t}},{key:"move",value:function(e,t){this.x+=e,this.y+=t}},{key:"toArray",value:function(){return[this.x,this.y,this.z]}}]),i}();function P(e){var t=Math.sqrt(e.x*e.x+e.y*e.y);return 1e-5<t?(e.x=e.x/t,e.y=e.y/t,e):null}function S(e,t){return[e[0]*t.x+e[1]*t.y,e[3]*t.x+e[4]*t.y]}function B(e,t){var i=e[0],n=e[1],r=e[2],o=e[3],s=e[4],a=e[5],u=t[0],h=t[1],l=t[3],c=t[4];return[u*i+h*o,u*n+h*s,u*r+h*a,l*i+c*o,l*n+c*s,l*r+c*a]}function k(e,t){var i=0;return i+=(e.x-t.x)*(e.x-t.x),i+=(e.y-t.y)*(e.y-t.y),Math.sqrt(i)}function L(e){return Math.sqrt(e.x*e.x+e.y*e.y)}function C(e,t){return(e.x*t.x+e.y*t.y)/(L(e)*L(t))}var O={Vector2:A};function I(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function M(e,t,i){return t&&I(e.prototype,t),i&&I(e,i),e}var j=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),function(e,t,i){t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i}(this,"_value",void 0),this._value=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}return M(e,[{key:"value",get:function(){return this._value}}]),M(e,[{key:"translate",value:function(e,t,i){this._value=Z(this._value,D(e,t,i))}},{key:"rotate",value:function(e,t,i){this._value=Z(this._value,q(e,t,i))}},{key:"scale",value:function(e,t,i){this._value=Z(this._value,W(e,t,i))}}]),e}();function F(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function z(e,t,i,n,r){var o=Math.tan(.5*Math.PI-.5*e),s=1/(n-r);return[o/(t/i),0,0,0,0,o,0,0,0,0,(n+r)*s,-1,0,0,n*r*s*2,0]}function U(e,t){return[2/e,0,0,0,0,-2/t,0,0,0,0,1,0,0,0,0,1]}function D(e,t,i){return[1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1]}function G(e,t){return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],t*e[0]+e[12],t*e[1]+e[13],t*e[2]+e[14],t*e[3]+e[15]]}function N(e,t){return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],t*e[4]+e[12],t*e[5]+e[13],t*e[6]+e[14],t*e[7]+e[15]]}function X(e,t){return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],t*e[8]+e[12],t*e[9]+e[13],t*e[10]+e[14],t*e[11]+e[15]]}function H(e){var t=Math.cos(e),i=Math.sin(e);return[1,0,0,0,0,t,i,0,0,-i,t,0,0,0,0,1]}function Y(e){var t=Math.cos(e),i=Math.sin(e);return[t,0,-i,0,0,1,0,0,i,0,t,0,0,0,0,1]}function V(e){var t=Math.cos(e),i=Math.sin(e);return[t,i,0,0,-i,t,0,0,0,0,1,0,0,0,0,1]}function W(e,t,i){return[e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1]}function q(e,t,i){return Z(Z(H(e),Y(t)),V(i))}function Z(e,t){var i=e[0],n=e[1],r=e[2],o=e[3],s=e[4],a=e[5],u=e[6],h=e[7],l=e[8],c=e[9],f=e[10],g=e[11],d=e[12],b=e[13],m=e[14],v=e[15],_=t[0],w=t[1],y=t[2],p=t[3],x=t[4],E=t[5],T=t[6],R=t[7],A=t[8],P=t[9],S=t[10],B=t[11],k=t[12],L=t[13],C=t[14],O=t[15];return[_*i+w*s+y*l+p*d,_*n+w*a+y*c+p*b,_*r+w*u+y*f+p*m,_*o+w*h+y*g+p*v,x*i+E*s+T*l+R*d,x*n+E*a+T*c+R*b,x*r+E*u+T*f+R*m,x*o+E*h+T*g+R*v,A*i+P*s+S*l+B*d,A*n+P*a+S*c+B*b,A*r+P*u+S*f+B*m,A*o+P*h+S*g+B*v,k*i+L*s+C*l+O*d,k*n+L*a+C*c+O*b,k*r+L*u+C*f+O*m,k*o+L*h+C*g+O*v]}function J(e,t){for(var i=0;i<e.length;i++)e[i]*=t;return e}function K(e,t){return[e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3],e[4]*t[0]+e[5]*t[1]+e[6]*t[2]+e[7]*t[3],e[8]*t[0]+e[9]*t[1]+e[10]*t[2]+e[11]*t[3],e[12]*t[0]+e[13]*t[1]+e[14]*t[2]+e[15]*t[3]]}function Q(e,t){for(var i=new Array(4),n=0;n<4;++n)for(var r=i[n]=0;r<4;++r)i[n]+=t[r]*e[4*r+n];return i}function $(e){var t=new Array(16),i=e[0],n=e[1],r=e[2],o=e[3],s=e[4],a=e[5],u=e[6],h=e[7],l=e[8],c=e[9],f=e[10],g=e[11],d=e[12],b=e[13],m=e[14],v=e[15],_=f*v,w=m*g,y=u*v,p=m*h,x=u*g,E=f*h,T=r*v,R=m*o,A=r*g,P=f*o,S=r*h,B=u*o,k=l*b,L=d*c,C=s*b,O=d*a,I=s*c,M=l*a,j=i*b,F=d*n,z=i*c,U=l*n,D=i*a,G=s*n,N=_*a+p*c+x*b-(w*a+y*c+E*b),X=w*n+T*c+P*b-(_*n+R*c+A*b),H=y*n+R*a+S*b-(p*n+T*a+B*b),Y=E*n+A*a+B*c-(x*n+P*a+S*c),V=1/(i*N+s*X+l*H+d*Y);return t[0]=V*N,t[1]=V*X,t[2]=V*H,t[3]=V*Y,t[4]=V*(w*s+y*l+E*d-(_*s+p*l+x*d)),t[5]=V*(_*i+R*l+A*d-(w*i+T*l+P*d)),t[6]=V*(p*i+T*s+B*d-(y*i+R*s+S*d)),t[7]=V*(x*i+P*s+S*l-(E*i+A*s+B*l)),t[8]=V*(k*h+O*g+I*v-(L*h+C*g+M*v)),t[9]=V*(L*o+j*g+U*v-(k*o+F*g+z*v)),t[10]=V*(C*o+F*h+D*v-(O*o+j*h+G*v)),t[11]=V*(M*o+z*h+G*g-(I*o+U*h+D*g)),t[12]=V*(C*f+M*m+L*u-(I*m+k*u+O*f)),t[13]=V*(z*m+k*r+F*f-(j*f+U*m+L*r)),t[14]=V*(j*u+G*m+O*r-(D*m+C*r+F*u)),t[15]=V*(D*f+I*r+U*u-(z*u+G*f+M*r)),t}function ee(e){var t=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];return t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t}var te={Matrix4:j,unit:F,projection:U,perspective:z,inverse:$,multiplyVector4:K,transpose:ee,multiply:Z,translation:D,translateX:G};function ie(e){return(ie="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ne(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function re(e){var i="function"==typeof Map?new Map:void 0;return(re=function(e){if(null===e||!function(e){return-1!==Function.toString.call(e).indexOf("[native code]")}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==i){if(i.has(e))return i.get(e);i.set(e,t)}function t(){return oe(e,arguments,ae(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),se(t,e)})(e)}function oe(e,t,i){return(oe=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,i){var n=[null];n.push.apply(n,t);var r=new(Function.bind.apply(e,n));return i&&se(r,i.prototype),r}).apply(null,arguments)}function se(e,t){return(se=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ae(e){return(ae=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ue(e){var t=e.getContext("experimental-webgl");if(null==t)throw new he("Cannot get WebGL context.");return window.addEventListener("resize",function(){e.width=e.offsetWidth,e.height=e.offsetHeight}),t}var he=function(e){function i(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),function(e,t,i){t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i}(ne(t=function(e,t){return!t||"object"!==ie(t)&&"function"!=typeof t?ne(e):t}(this,ae(i).call(this,e))),"name","WebglError"),Error.captureStackTrace(ne(t),i),t}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&se(e,t)}(i,re(Error)),i}();function le(e){return(le="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ce(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function fe(e){var i="function"==typeof Map?new Map:void 0;return(fe=function(e){if(null===e||!function(e){return-1!==Function.toString.call(e).indexOf("[native code]")}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==i){if(i.has(e))return i.get(e);i.set(e,t)}function t(){return ge(e,arguments,be(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),de(t,e)})(e)}function ge(e,t,i){return(ge=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,i){var n=[null];n.push.apply(n,t);var r=new(Function.bind.apply(e,n));return i&&de(r,i.prototype),r}).apply(null,arguments)}function de(e,t){return(de=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function be(e){return(be=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function me(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ve(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _e(e,t,i){return t&&ve(e.prototype,t),i&&ve(e,i),e}function we(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var ye=function(){function t(e){return me(this,t),we(this,"webGL",void 0),we(this,"VERTEX_SHADER","vertex"),we(this,"FRAGMENT_SHADER","fragment"),we(this,"ATTRIBUTE","attribute"),we(this,"UNIFORM","uniform"),we(this,"_program",null),we(this,"_vertexShader",null),we(this,"_fragmentShader",null),this.webGL=e,this}return _e(t,[{key:"program",get:function(){return this._program}}]),_e(t,[{key:"addShader",value:function(e,t){var i;switch(e){case"vertex":i=this.webGL.createShader(this.webGL.VERTEX_SHADER),this._vertexShader=i;break;case"fragment":i=this.webGL.createShader(this.webGL.FRAGMENT_SHADER),this._fragmentShader=i;break;default:throw new pe("Wrong shader type.")}if(this.webGL.shaderSource(i,t),this.webGL.compileShader(i),!this.webGL.getShaderParameter(i,this.webGL.COMPILE_STATUS))throw console.error("There are shader error:"),console.error(this.webGL.getShaderInfoLog(i)),new pe("Could not compile shader.")}},{key:"create",value:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0],t=this.webGL.createProgram();if(null==this._vertexShader&&null==this._fragmentShader)throw new pe("Shader programs isn`t complete.");return this.webGL.attachShader(t,this._vertexShader),this.webGL.attachShader(t,this._fragmentShader),this.webGL.linkProgram(t),this.webGL.useProgram(t),e&&(this.webGL.deleteShader(this._vertexShader),this.webGL.deleteShader(this._fragmentShader)),this._program=t}},{key:"linkVariable",value:function(e,t,i){if(void 0!==this[i=i||t]&&(console.warn("Shader program: Custom name for uniform was switched from "+i+" to "+i+"1"),i+="1"),null==this._program)throw new pe("Shader program is null.");switch(e){case this.ATTRIBUTE:this[i]=this.webGL.getAttribLocation(this._program,t);break;case this.UNIFORM:this[i]=this.webGL.getUniformLocation(this._program,t);break;default:throw"Wrong variable type"}return this[i]}},{key:"linkAttribute",value:function(e,t){if(null!=this[t=t||e]&&(console.warn("Shader program: Custom name for uniform was switched from "+t+" to "+t+"1"),t+="1"),null==this._program)throw new pe("Shader program is null.");if(this[t]=this.webGL.getAttribLocation(this.program,e),null==this[t])throw new Error("Can not link uniform "+e+". The variable may not be used in shader.");return this[t]}},{key:"linkUniform",value:function(e,t){if(null!=this[t=t||e]&&(console.warn("Shader program: Custom name for attribute was switched from "+t+" to "+t+"1"),t+=""),null==this._program)throw new pe("Shader program is null.");if(this[t]=this.webGL.getUniformLocation(this.program,e),null==this[t])throw new Error("Can not link uniform "+e+". The variable may not be used in shader.");return this[t]}},{key:"use",value:function(){this.webGL.useProgram(this.program)}},{key:"useIn",value:function(e){e.useProgram(this.program)}}]),t}(),pe=function(e){function i(e){var t;return me(this,i),we(ce(t=function(e,t){return!t||"object"!==le(t)&&"function"!=typeof t?ce(e):t}(this,be(i).call(this,e))),"name","WebglError"),Error.captureStackTrace(ce(t),i),t}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&de(e,t)}(i,fe(Error)),i}(),xe=ye;function Ee(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Te(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Re(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var Ae=function(){function i(e){Ee(this,i),Re(this,"extensions",new Pe),Re(this,"webGL",void 0),Re(this,"shadersRequireLights",[]),this.webGL=e;var t={removePrefixes:!0,addLocationMarker:!0};this.addExtension("anisotropic","EXT_texture_filter_anisotropic"),this.addExtension("standard","OES_standard_derivatives"),this.addProgram("default","#define MAX_LIGHTS 28\r\n\r\nattribute vec4 a_position;\r\nattribute vec2 a_texcoord;\r\nattribute vec4 a_normal;\r\n\r\nuniform mat4 u_matrix;\r\nuniform mat4 u_objectRotation;\r\nuniform mat4 u_worldMatrix;\r\n\r\nuniform vec3 u_lightPositions[MAX_LIGHTS];\r\nuniform int u_lightsCount;\r\n\r\nvarying vec2 v_texcoord;\r\nvarying vec3 v_normal;\r\nvarying vec3 v_lightsDirections[MAX_LIGHTS];\r\nvarying float v_lightsCount;\r\n\r\nvoid main() {\r\n    gl_Position = u_matrix * a_position;\r\n    \r\n    v_texcoord = a_texcoord;\r\n    v_normal = vec3(u_objectRotation * a_normal);\r\n\r\n    vec3 surfaceWorldPosition = (u_worldMatrix  * a_position).xyz;\r\n    for (int i = 0; i < MAX_LIGHTS; i++) {\r\n        if (i > int(u_lightsCount)) {\r\n            break;\r\n        }\r\n        v_lightsDirections[i] = u_lightPositions[i] - surfaceWorldPosition;\r\n    }\r\n\r\n    v_lightsCount = float(u_lightsCount);\r\n}\r\n","#define MAX_LIGHTS 28\r\n\r\nprecision mediump float;\r\n\r\nvarying vec2 v_texcoord;\r\nvarying vec3 v_normal;\r\n\r\nuniform sampler2D u_texture;\r\nuniform float u_lightRanges[MAX_LIGHTS];\r\nuniform float u_lightMinValue;\r\n\r\nvarying vec3 v_lightsDirections[MAX_LIGHTS];\r\nvarying float v_lightsCount;\r\n\r\nfloat computeLight(vec3 direction, float range) {\r\n    float light = dot(v_normal, normalize(direction));\r\n    float k = (range - length(direction)) / range;\r\n    if (k < 0.0) k = 0.0;\r\n    light = light * k;\r\n    if (light < u_lightMinValue) {\r\n        light = u_lightMinValue;\r\n    }\r\n    return light;\r\n}\r\n\r\nvoid main() {\r\n    float light = 0.0;\r\n\r\n    for (int i = 0; i < MAX_LIGHTS; i++) {\r\n        if (i > int(v_lightsCount)) {\r\n            break;\r\n        }\r\n        light += computeLight(v_lightsDirections[i], u_lightRanges[i]);\r\n    }\r\n    \r\n    gl_FragColor = texture2D(u_texture, v_texcoord);\r\n    if (gl_FragColor.a == 0.0) {\r\n        discard;\r\n    }\r\n    gl_FragColor.rgb *= (light);\r\n    gl_FragColor.rgb *= gl_FragColor.a;\r\n}\r\n",t),this.addProgram("cube","#define MAX_LIGHTS 28\r\n\r\nattribute vec4 a_position;\r\nattribute vec2 a_texcoord;\r\nattribute vec4 a_normal;\r\n\r\nuniform mat4 u_matrix;\r\nuniform mat4 u_objectRotation;\r\nuniform vec3 u_lightPositions[MAX_LIGHTS];\r\nuniform int u_lightsCount;\r\nuniform mat4 u_worldMatrix;\r\n\r\nvarying vec3 v_normal;\r\nvarying vec3 v_normalTex;\r\nvarying vec3 v_lightsDirections[MAX_LIGHTS];\r\nvarying float v_lightsCount;\r\n\r\n\r\nvoid main() {\r\n    gl_Position = u_matrix * a_position;\r\n    \r\n    v_normal = vec3(u_objectRotation * a_normal);\r\n    v_normalTex = normalize(a_position.xyz);\r\n\r\n    vec3 surfaceWorldPosition = (u_worldMatrix  * a_position).xyz;\r\n    for (int i = 0; i < MAX_LIGHTS; i++) {\r\n        if (i > int(u_lightsCount)) {\r\n            break;\r\n        }\r\n        v_lightsDirections[i] = u_lightPositions[i] - surfaceWorldPosition;\r\n    }\r\n\r\n    v_lightsCount = float(u_lightsCount);\r\n}\r\n","#define MAX_LIGHTS 28\r\n\r\nprecision mediump float;\r\n\r\nvarying vec3 v_normal;\r\nvarying vec3 v_normalTex;\r\n\r\nuniform samplerCube u_texture;\r\nuniform float u_lightRanges[MAX_LIGHTS];\r\nuniform float u_lightMinValue;\r\n\r\nvarying vec3 v_lightsDirections[MAX_LIGHTS];\r\nvarying float v_lightsCount;\r\n\r\nfloat computeLight(vec3 direction, float range) {\r\n    float light = dot(v_normal, normalize(direction));\r\n    float k = (range - length(direction)) / range;\r\n    if (k < 0.0) k = 0.0;\r\n    light = light * k;\r\n    if (light < u_lightMinValue) {\r\n        light = u_lightMinValue;\r\n    }\r\n    return light;\r\n}\r\n\r\nvoid main() {\r\n    float light = 0.0;\r\n    for (int i = 0; i < MAX_LIGHTS; i++) {\r\n        if (i > int(v_lightsCount)) {\r\n            break;\r\n        }\r\n        light += computeLight(v_lightsDirections[i], u_lightRanges[i]);\r\n    }\r\n    \r\n    gl_FragColor = textureCube(u_texture, v_normalTex);\r\n    if (gl_FragColor.a == 0.0) {\r\n        discard;\r\n    }\r\n    gl_FragColor.rgb *= (light);\r\n    gl_FragColor.rgb *= gl_FragColor.a;\r\n}\r\n",t),this.addProgram("grid","attribute vec4 a_position;\r\nattribute vec2 a_texcoord;\r\n\r\nuniform mat4 u_matrix;\r\nuniform vec2 u_moving;\r\nuniform vec2 u_cellSize;\r\n\r\nvarying vec2 v_texcoord;\r\n\r\nvoid main() {\r\n    gl_Position = u_matrix * a_position;\r\n    v_texcoord = vec2(a_texcoord.x + u_moving.x / u_cellSize.x, a_texcoord.y + (u_moving.y / u_cellSize.x));\r\n}","precision mediump float;\r\n\r\nvarying vec2 v_texcoord;\r\n\r\nuniform sampler2D u_texture;\r\n\r\nvoid main() {\r\n    gl_FragColor = texture2D(u_texture, v_texcoord);\r\n}",t),this.addProgram("reflection","#define MAX_LIGHTS 28\r\n\r\nattribute vec4 a_position;\r\nattribute vec3 a_normal;\r\n    \r\nuniform mat4 u_matrix;\r\nuniform mat4 u_rotationMatrix;\r\nuniform mat4 u_worldMatrix;\r\nuniform vec3 u_lightPositions[MAX_LIGHTS];\r\nuniform int u_lightsCount;\r\n\r\nvarying vec3 v_worldRotation;\r\nvarying vec3 v_normal;\r\nvarying vec3 v_surfaceToLightDirection;\r\nvarying vec3 v_lightsDirections[MAX_LIGHTS];\r\nvarying float v_lightsCount;\r\n    \r\nvoid main() {\r\n    gl_Position = u_matrix * a_position;\r\n    v_worldRotation = (u_rotationMatrix * a_position).xyz;\r\n    v_normal =  vec3(a_normal);\r\n\r\n    vec3 surfaceWorldPosition = (u_worldMatrix  * a_position).xyz;\r\n    for (int i = 0; i < MAX_LIGHTS; i++) {\r\n        if (i > int(u_lightsCount)) {\r\n            break;\r\n        }\r\n        v_lightsDirections[i] = u_lightPositions[i] - surfaceWorldPosition;\r\n    }\r\n\r\n    v_lightsCount = float(u_lightsCount);\r\n}","#define MAX_LIGHTS 28\r\n\r\nprecision highp float;\r\n    \r\nuniform samplerCube u_texture;\r\nuniform float u_lightRanges[MAX_LIGHTS];\r\nuniform float u_lightMinValue;\r\n\r\nvarying vec3 v_lightsDirections[MAX_LIGHTS];\r\nvarying float v_lightsCount;\r\nvarying vec3 v_worldRotation;\r\nvarying vec3 v_normal;\r\nvarying vec3 v_surfaceToLightDirection;\r\n        \r\nfloat computeLight(vec3 direction, float range) {\r\n    float light = dot(normalize(v_worldRotation), normalize(direction));\r\n    float k = (range - length(direction)) / range;\r\n    if (k < 0.0) k = 0.0;\r\n    light = light * k;\r\n    if (light < u_lightMinValue) {\r\n        light = u_lightMinValue;\r\n    }\r\n    return light;\r\n}\r\n\r\nvoid main() {\r\n    vec3 worldNormal = normalize(v_normal);\r\n    vec3 eyeToSurfaceDir = normalize(v_worldRotation);\r\n    vec3 direction = reflect(eyeToSurfaceDir, vec3(0.0, 0.0, -1.0));\r\n    \r\n    gl_FragColor = textureCube(u_texture, direction);\r\n\r\n    float light = 0.0;\r\n\r\n    for (int i = 0; i < MAX_LIGHTS; i++) {\r\n        if (i > int(v_lightsCount)) {\r\n            break;\r\n        }\r\n        light += computeLight(v_lightsDirections[i], u_lightRanges[i]);\r\n    }\r\n\r\n    gl_FragColor.rgb *= (light);\r\n    if (gl_FragColor.a == 0.0) {\r\n        discard;\r\n    }\r\n    gl_FragColor.rgb *= gl_FragColor.a;\r\n}",t),this.addProgram("skybox","attribute vec4 a_position;\r\nvarying vec4 v_position;\r\nvoid main() {\r\n    v_position = a_position;\r\n    gl_Position = a_position;\r\n    gl_Position.z = .9999999;\r\n}","    precision mediump float;\r\n     \r\n    uniform samplerCube u_texture;\r\n    uniform mat4 u_matrix;\r\n     \r\n    varying vec4 v_position;\r\n    void main() {\r\n      vec4 t = u_matrix * v_position;\r\n      gl_FragColor = textureCube(u_texture, normalize(t.xyz / t.w));\r\n    }",t),this.addProgram("screen","attribute vec4 a_position;\r\nattribute vec2 a_texcoord;\r\n\r\nvarying vec2 v_texcoord;\r\n\r\n\r\nvoid main() {\r\n    gl_Position = a_position;\r\n\r\n    v_texcoord = a_texcoord;\r\n}\r\n","precision mediump float;\r\n\r\nvarying vec2 v_texcoord;\r\nvarying vec3 v_normal;\r\n\r\nuniform sampler2D u_texture;\r\n\r\nvoid main() {\r\n    gl_FragColor = texture2D(u_texture, v_texcoord);\r\n    if (gl_FragColor.a == 0.0) {\r\n        discard;\r\n    }\r\n    gl_FragColor.rgb *= gl_FragColor.a;\r\n}\r\n",t),this.default.use(),this.webGL.enable(this.webGL.BLEND),this.webGL.blendFunc(this.webGL.ONE,this.webGL.ONE_MINUS_SRC_ALPHA)}return function(e,t,i){t&&Te(e.prototype,t),i&&Te(e,i)}(i,[{key:"addProgram",value:function(e,t,i,n){var r=new xe(this.webGL);r.addShader("vertex",t),r.addShader("fragment",i),r.create(),r=this._linkAllAttributesFromSource(r,t,n),r=this._linkAllAttributesFromSource(r,i,n),this[e]=r}},{key:"_linkAllAttributesFromSource",value:function(a,e,u){var h;return e.split(";").join("\r").split("\r").forEach(function(e){for(var t=(e=(e=e.replace(new RegExp("\r","g"),"")).replace(new RegExp("\n","g"),"")).split(" "),i=t.length-1;i--;)""===t[i]&&t.splice(i,1);if(t[0].toLowerCase().includes("attribute")){var n=t[2],r=n.indexOf("[");-1!=r&&(n=n.slice(0,r)),h=n,u&&u.removePrefixes&&(h=h.slice(2,h.length)),u&&u.addLocationMarker&&(h+="Location"),a.linkAttribute(t[2],h)}else if(t[0].toLowerCase().includes("uniform")){var o=t[2],s=o.indexOf("[");-1!=s&&(o=o.slice(0,s)),h=o,u&&u.removePrefixes&&(h=h.slice(2,h.length)),u&&u.addLocationMarker&&(h+="Location"),a.linkUniform(o,h)}}),a}},{key:"addExtension",value:function(e,t){this.extensions[e]=this.webGL.getExtension(t)}}]),i}(),Pe=function e(){Ee(this,e)};function Se(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function Be(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ke(e){throw Be(this,ke),new Le(e)}var Le=function e(t){Be(this,e),Se(this,"name","BronzeError"),Se(this,"message",void 0),Error.apply(this,[t]),this.message=t};Le.prototype=new Error;function Ce(e){Be(this,Ce),console.warn(e)}var Oe=ke;function Ie(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Me(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var je=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),Me(this,"alpha",!1),Me(this,"color",new Uint8Array([229,91,91,255])),Me(this,"engine",void 0),Me(this,"textureBlockLocation",-1),Me(this,"loaded",!1),Me(this,"webglTexture",void 0),this.engine=e}return function(e,t,i){t&&Ie(e.prototype,t),i&&Ie(e,i)}(t,[{key:"setColor",value:function(e,t,i,n){if(e.constructor instanceof String){var r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(String(e));if(null==r)return void new Oe("Wrong hex color!");this.color=new Uint8Array([parseInt(r[0]),parseInt(r[1]),parseInt(r[2]),255])}else{if(e.constructor!==Number||null==t||null==i||null==n)return void new Oe("Wrong color");this.color=new Uint8Array([Number(e),t,i,n])}var o=this.engine.webgl;o.activeTexture(o.TEXTURE0+this.textureBlockLocation),o.bindTexture(o.TEXTURE_2D,this.webglTexture),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,1,1,0,o.RGBA,o.UNSIGNED_BYTE,this.color)}}]),t}();function Fe(e){return(Fe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ze(e){return(ze=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Ue(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function De(e,t){return(De=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ge=function(e){function n(e){var t;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),function(e,t,i){t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i}(Ue(t=function(e,t){return!t||"object"!==Fe(t)&&"function"!=typeof t?Ue(e):t}(this,ze(n).call(this,e))),"textureBlockLocation",-1),t.engine=e,t.textureBlockLocation=t.engine.textures.length,t.engine.textures.push(Ue(t));var i=t.engine.webgl;return t.webglTexture=i.createTexture(),i.activeTexture(i.TEXTURE0+t.textureBlockLocation),i.bindTexture(i.TEXTURE_2D,t.webglTexture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,1,1,0,i.RGBA,i.UNSIGNED_BYTE,t.color),t.engine.textureLoaded(Ue(t)),t.loaded=!0,t}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&De(e,t)}(n,je),n}();function Ne(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Xe(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var He,Ye=function(){function i(e){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),Xe(this,"div",void 0),Xe(this,"canvas",void 0),Xe(this,"webgl",void 0),Xe(this,"width",void 0),Xe(this,"height",void 0),Xe(this,"camera",null),Xe(this,"debugger",null),Xe(this,"controls",null),Xe(this,"lightsPositions",[]),Xe(this,"lightsRanges",[]),Xe(this,"globalLightMinValue",.5),Xe(this,"noTexture",void 0),Xe(this,"reflections",!1),Xe(this,"status","Creating"),Xe(this,"selectedObject",null),Xe(this,"shaders",void 0),Xe(this,"textures",[]),Xe(this,"lights",[]),Xe(this,"_ui",null),Xe(this,"_objectsWithoutAlpha",[]),Xe(this,"_objectsWithAlpha",[]),Xe(this,"_resourcesLoaded",!1),Xe(this,"_texturesLoaded",!1),Xe(this,"_objectsLoaded",!1),Xe(this,"_loadedObjectsCount",0),Xe(this,"_loadedTexturesCount",0),Xe(this,"_onResourcesLoadedHandlers",[]),Xe(this,"_onObjectSelectedHandlers",[]),Xe(this,"_running",!1),Xe(this,"_onRun",[]),Xe(this,"_onFrameHandlers",[]),this.div=e,this.width=e.offsetWidth,this.height=e.offsetHeight,this.canvas=document.createElement("canvas"),this.canvas.width=e.offsetWidth,this.canvas.height=e.offsetHeight,this.webgl=ue(this.canvas),this.addOnResourcesLoadedListener(function(){t.reflections?t.status="Creating reflections":(t.appendCanvas(),t.status="Drawing")}),this.shaders=new Ae(this.webgl),this.shaders.default.use(),this.webgl.viewport(0,0,this.width,this.height),this.webgl.enable(this.webgl.CULL_FACE),this.webgl.enable(this.webgl.DEPTH_TEST),this.noTexture=new Ge(this),this.infoConsoleLog()}return function(e,t,i){t&&Ne(e.prototype,t),i&&Ne(e,i)}(i,[{key:"appendCanvas",value:function(){this.div.appendChild(this.canvas),this.onCanvasResized()}},{key:"setCamera",value:function(e){this.camera=e}},{key:"onCanvasResized",value:function(){0!=this.canvas.clientWidth&&(this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.width=this.canvas.clientWidth,this.height=this.canvas.clientHeight),this.webgl.viewport(0,0,this.width,this.height)}},{key:"addObject",value:function(e){e.texture.alpha?this._objectsWithAlpha.push(e):this._objectsWithoutAlpha.push(e)}},{key:"removeObject",value:function(e){var t=-1;return e.texture.alpha?(-1==(t=this._objectsWithAlpha.indexOf(e))&&(console.warn("Objects",this.objects),new Oe("Object not found")),this._objectsWithAlpha.splice(t,1)[0]):(-1==(t=this._objectsWithoutAlpha.indexOf(e))&&(console.warn("Objects",this.objects),new Oe("Object not found")),this._objectsWithoutAlpha.splice(t,1)[0])}},{key:"addOnObjectSelectedListener",value:function(e){this._onObjectSelectedHandlers.push(e)}},{key:"addOnResourcesLoadedListener",value:function(e){this._onResourcesLoadedHandlers.push(e)}},{key:"textureLoaded",value:function(e){this._loadedTexturesCount+=1,e.loaded=!0,this.running&&this._loadedTexturesCount==this.textures.length&&(this._texturesLoaded=!0,this.objectsLoaded&&(this._resourcesLoaded=!0,this._onResourcesLoadedHandlers.forEach(function(e){e()})))}},{key:"objectLoaded",value:function(e){var t=this.objects.length;this.ui&&(t+=this.ui.objects.length),this._loadedObjectsCount+=1,e.loaded=!0,this.running&&this._loadedObjectsCount>=t&&(this._objectsLoaded=!0,this._texturesLoaded&&(this._resourcesLoaded=!0,this._onResourcesLoadedHandlers.forEach(function(e){e()})))}},{key:"setDrawingRange",value:function(e){if(null==this.camera)throw"Failed to set drawing range. Camera wasn't set.";this.camera.range=e}},{key:"captureFrame",value:function(e,t){var i=this.camera,n=[this.canvas.width,this.canvas.height],r=!1,o=128,s=128,a="rgba(0, 0, 0, 0)",u=1,h=1,l=[];null!=t&&(r=t.drawUI||r,o=t.height||o,s=t.width||s,a=t.background||a,u=t.backgroundAlpha||u,h=t.imageAlpha||h,l=t.noDrawObjects||[]),this.width=s,this.height=o,this.canvas.width=s,this.canvas.height=o,this.onCanvasResized(),this.camera=e,this.webgl.clear(this.webgl.COLOR_BUFFER_BIT|this.webgl.DEPTH_BUFFER_BIT),this.shaders.default.use(),this.webgl.uniform3fv(this.shaders.default.lightPositionsLocation,this.lightsPositions),this.webgl.uniform1fv(this.shaders.default.lightRangesLocation,this.lightsRanges),this.webgl.uniform1i(this.shaders.default.lightsCountLocation,this.lights.length),this.webgl.uniform1f(this.shaders.default.lightMinValueLocation,this.globalLightMinValue),this.update();for(var c=0;c<this.objects.length;c++){var f=this.objects[c];-1==l.indexOf(f)&&(!r&&f.UIElement||f.draw())}var g=document.createElement("canvas");g.height=this.canvas.height,g.width=this.canvas.width;var d=g.getContext("2d");return d.globalAlpha=u,"string"==typeof a?(d.fillStyle=a,d.fillRect(0,0,this.canvas.width,this.canvas.height)):a.constructor===HTMLImageElement&&d.drawImage(a,0,0,g.width,g.height),d.globalAlpha=h,d.drawImage(this.canvas,0,0),this.camera=i,this.canvas.width=n[0],this.canvas.height=n[1],this.width=n[0],this.height=n[1],this.onCanvasResized(),g}},{key:"render",value:function(){this.beforeFrame(),this.update(),this.draw()}},{key:"run",value:function(){var t=this;(He=this)._running=!0,this.status="Loading resources",this._loadedTexturesCount==this.textures.length&&(this._texturesLoaded=!0);var e=this.objects.length;this.ui&&(e+=this.ui.objects.length+1),this._loadedObjectsCount==e&&(this._objectsLoaded=!0,this.textureLoaded&&(this._resourcesLoaded=!0,this._onResourcesLoadedHandlers.forEach(function(e){e(t.textures.length)}))),Ve();for(var i=0;i<this._onRun.length;i++)this._onRun[i]}},{key:"stop",value:function(){this._running=!1}},{key:"addOnFrameHandler",value:function(e){return this._onFrameHandlers.push(e),e}},{key:"removeOnFrameHandler",value:function(e){var t=this._onFrameHandlers.indexOf(e);this._onFrameHandlers.splice(t,1)}},{key:"beforeFrame",value:function(){for(var e=0;e<this._onFrameHandlers.length;e++){(0,this._onFrameHandlers[e])()}}},{key:"update",value:function(){var i=this;this.camera&&this.controls&&this.controls.controlFunction&&(this.camera.moving.set(0,0,0),this.camera.moving.add(this.camera.animatedMoving),this.controls.controlFunction(),null!=this.debugger&&this.debugger.updateInfo(),this.controls.mouse.movement.x=0,this.controls.mouse.movement.y=0),this.selectedObject=null;for(var e=0;e<this._objectsWithoutAlpha.length;e++){var t=this._objectsWithoutAlpha[e];t.updateMatrixes(),t.checkCollision&&t.checkCollision(this.camera.position,this.camera.moving,this.camera.collisionBox,function(e){i.camera.moving[e]=0})}for(var n=0;n<this._objectsWithAlpha.length;n++){var r=this._objectsWithAlpha[n];r.updateMatrixes(),r.checkCollision&&r.checkCollision(this.camera.position,this.camera.moving,this.camera.collisionBox,function(e){i.camera.moving[e]=0})}if(this.camera.position.move(this.camera.moving.x,this.camera.moving.y,this.camera.moving.z),this.camera.computeMatrix(),this.ui.objects.forEach(function(e){e.updateMatrixes(),e.update()}),this._objectsWithoutAlpha.forEach(function(e,t){e.update(),e.texture.alpha&&(i._objectsWithAlpha.push(e),i._objectsWithoutAlpha.splice(t,1))}),this._objectsWithAlpha.sort(function(e,t){return y(t.position,i.camera.position)-y(e.position,i.camera.position)}),this._objectsWithAlpha.forEach(function(e){e.update()}),this.selectedObject&&0<this._onObjectSelectedHandlers.length)for(var o=0;o<this._onObjectSelectedHandlers.length;o++)this._onObjectSelectedHandlers[o]()}},{key:"draw",value:function(){var t=this;this.webgl.clear(this.webgl.COLOR_BUFFER_BIT|this.webgl.DEPTH_BUFFER_BIT),this.shaders.default.use(),this.webgl.uniform3fv(this.shaders.default.lightPositionsLocation,this.lightsPositions),this.webgl.uniform1fv(this.shaders.default.lightRangesLocation,this.lightsRanges),this.webgl.uniform1i(this.shaders.default.lightsCountLocation,this.lights.length),this.webgl.uniform1f(this.shaders.default.lightMinValueLocation,this.globalLightMinValue),this.shaders.shadersRequireLights.forEach(function(e){e.use(),t.webgl.uniform3fv(e.lightPositionsLocation,t.lightsPositions),t.webgl.uniform1fv(e.lightRangesLocation,t.lightsRanges),t.webgl.uniform1i(e.lightsCountLocation,t.lights.length),t.webgl.uniform1f(e.lightMinValueLocation,t.globalLightMinValue)}),this.ui.draw(),this.objects.forEach(function(e){e.draw()}),this._objectsWithAlpha.forEach(function(e){e.draw()}),this.ui.drawUI()}},{key:"infoConsoleLog",value:function(){console.log(),console.log("   %c%s","color: rgba(247, 137, 74, 1); text-align: center; font-size: 16px; font-weight: 700","Bronze Engine is running"),console.log(),console.info("   Version : 0.3.00"),console.info("   Docs  : http://m0ksem.design/Bronze-Engine/docs/global"),console.info("   GitHub  : https://github.com/m0ksem/Bronze-Engine"),console.info("   Author  : https://github.com/m0ksem"),console.log()}},{key:"ui",set:function(e){this._ui=e;var t=this.objects.length+this.ui.objects.length;this._loadedObjectsCount+=1,this.running&&this._loadedObjectsCount==t&&(this._objectsLoaded=!0,this._texturesLoaded&&(this._resourcesLoaded=!0,this._onResourcesLoadedHandlers.forEach(function(e){e()})))},get:function(){return this._ui}},{key:"objects",get:function(){return this._objectsWithoutAlpha.concat(this._objectsWithAlpha)}},{key:"resourcesLoaded",get:function(){return this._resourcesLoaded}},{key:"texturesLoaded",get:function(){return this._texturesLoaded}},{key:"objectsLoaded",get:function(){return this._objectsLoaded}},{key:"running",get:function(){return this._running}}]),i}();function Ve(){He.running&&(requestAnimationFrame(Ve),He.render())}function We(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function qe(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Ze(e,t,i){return t&&qe(e.prototype,t),i&&qe(e,i),e}function Je(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}!function(){for(var r=0,e=["ms","moz","webkit","o"],t=window,i=0;i<e.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=t[e[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=t[e[i]+"CancelAnimationFrame"]||t[e[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e){var t=(new Date).getTime(),i=Math.max(0,16-(t-r)),n=window.setTimeout(function(){e(t+i)},i);return r=t+i,n}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}();var Ke=function(){function t(e){We(this,t),Je(this,"name","Just entity :)"),Je(this,"loaded",!1),Je(this,"verticalAlign",!0),Je(this,"vertexes",[]),Je(this,"textureCoordinates",[]),Je(this,"normals",[]),Je(this,"vertexesBuffer",null),Je(this,"textureCoordinatesBuffer",null),Je(this,"normalsBuffer",null),Je(this,"matrix",[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),Je(this,"rotationMatrix",[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),Je(this,"worldMatrix",[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),Je(this,"uiMatrix",null),Je(this,"texture",void 0),Je(this,"rotationInDeg",new g(0,0,0)),Je(this,"rotation",new g(0,0,0)),Je(this,"rotationSelf",new g(0,0,0)),Je(this,"rotationPoint",new g(0,0,0)),Je(this,"scaling",new g(1,1,1)),Je(this,"selectable",!1),Je(this,"relativeToCameraPosition",{max:{x:0,y:0},min:{x:0,y:0},depth:0}),Je(this,"_engine",void 0),Je(this,"webgl",void 0),Je(this,"camera",void 0),Je(this,"maxSize",new g(0,0,0)),Je(this,"minSize",new g(0,0,0)),Je(this,"maxBaseSize",new g(0,0,0)),Je(this,"minBaseSize",new g(0,0,0)),Je(this,"hidden",!1),Je(this,"rotationPointPos",null),Je(this,"shaderProgram",void 0),Je(this,"_collisionBox",new Qe),Je(this,"_UIElement",!1),Je(this,"_animationInterval",void 0),Je(this,"_position",new g(0,0,0)),this._engine=e,this.webgl=e.webgl,this.camera=e.camera,this.texture=this._engine.noTexture,this.shaderProgram=e.shaders.default,e.addObject(this)}return Ze(t,[{key:"setPosition",value:function(e,t,i){e.constructor===g?this.position=e:e.constructor===Array?this.UIElement?this._position.set(this.engine.width/100*e[0],-this.engine.height/100*e[1],e[2]):this._position.set(e[0],e[1],e[2]):this.UIElement?this._position.set(this.engine.width/100*e,-this.engine.height/100*t,i):this._position.set(e,t,i)}},{key:"move",value:function(e,t,i){this._position.move(e,t,i)}},{key:"moveRelativeToTheCamera",value:function(e,t,i){this._position.move(e,t,i)}},{key:"setRotation",value:function(e,t,i){var n=u(e),r=u(t),o=u(i);this.rotationInDeg.set(e,t,i),this.rotation.set(n,r,o)}},{key:"rotate",value:function(e,t,i){var n=u(e),r=u(t),o=u(i);this.rotationInDeg.move(e,t,i),this.rotation.move(n,r,o)}},{key:"rotateSelf",value:function(e,t,i){var n=u(e),r=u(t),o=u(i);this.rotationInDeg.move(e,t,i),this.rotationSelf.move(n,r,o)}},{key:"setRotationPoint",value:function(e,t,i){if(e.constructor===String)switch(e){case"center":this.rotationPoint.set(0,0,0),this.rotationPoint.set(0,0,0),this.rotationPoint.set(0,0,0),this.rotationPointPos="center";break;default:new ke("Wrong point type")}else this.rotationPoint.set(e,t,i)}},{key:"scale",value:function(e,t,i){this.scaling.set(e,t,i),this.maxSize.set(this.maxBaseSize.x*e,this.maxBaseSize.y*t,this.maxBaseSize.z*i),this.minSize.set(this.minBaseSize.x*e,this.minBaseSize.y*t,this.minBaseSize.z*i)}},{key:"scaleToPixels",value:function(e,t,i){e=null!=e?e/Math.abs(this.maxBaseSize.x-this.minBaseSize.x):this.scaling.x,t=null!=t?t/Math.abs(this.maxBaseSize.y-this.minBaseSize.y):this.scaling.y,i=null!=i?i/Math.abs(this.maxBaseSize.z-this.minBaseSize.z):this.scaling.z,this.scaling.set(e,t,i)}},{key:"scaleToPixelsX",value:function(e){e/=Math.abs(this.maxBaseSize.x-this.minBaseSize.x),this.scaling.set(e,e,e)}},{key:"resize",value:function(e,t,i){e/=this.maxBaseSize.x,t/=this.maxBaseSize.y,i/=this.maxBaseSize.z,this.scaling.set(e,t,i),this.maxSize.set(this.maxBaseSize.x*e,this.maxBaseSize.y*t,this.maxBaseSize.z*i),this.minSize.set(this.minBaseSize.x*e,this.minBaseSize.y*t,this.minBaseSize.z*i)}},{key:"setTexture",value:function(e){this.texture=e}},{key:"checkCollision",value:function(e,t,i,n){if(!this.hidden&&this.engine.camera.moved){var r=[this.collisionBox.maxPoint.x,this.collisionBox.maxPoint.y,this.collisionBox.maxPoint.z,1],o=[this.collisionBox.minPoint.x,this.collisionBox.minPoint.y,this.collisionBox.minPoint.z,1];if(r=Q(this.worldMatrix,r),o=Q(this.worldMatrix,o),r[0]<o[0]){var s=r[0];r[0]=o[0],o[0]=s}var a=r[0]-i.minPoint.x,u=o[0]-i.maxPoint.x;if(r[1]<o[1]){var h=r[1];r[1]=o[1],o[1]=h}var l=r[1]-i.minPoint.y,c=o[1]-i.maxPoint.y;if(r[2]<o[2]){var f=r[2];r[2]=o[2],o[2]=f}var g=r[2]-i.minPoint.z,d=o[2]-i.maxPoint.z,b=e.x+t.x,m=e.y+t.y,v=e.z+t.z;e.y>c&&e.y<l&&e.z>d&&e.z<g&&(e.x<u&&u<=b||e.x>a&&b<=a)&&n("x"),e.x>u&&e.x<a&&e.z>d&&e.z<g&&(e.y<c&&c<=m||e.y>l&&m<=l)&&n("y"),e.y>c&&e.y<l&&e.x>u&&e.x<a&&(e.z<d&&d<=v||e.z>g&&v<=g)&&n("z")}}},{key:"useShader",value:function(e){this.shaderProgram=e}},{key:"updateRelativeToCameraPosition",value:function(){for(var e=[this.collisionBox.maxPoint.x,this.collisionBox.minPoint.x],t=[this.collisionBox.maxPoint.y,this.collisionBox.minPoint.y],i=[this.collisionBox.maxPoint.z,this.collisionBox.minPoint.z],n=[1e6,1e6],r=[-1e6,-1e6,-1e6],o=0;o<2;o++)for(var s=e[o],a=0;a<2;a++)for(var u=t[a],h=0;h<2;h++){var l=i[h],c=Q(this.matrix,[s,u,l,1]);c[0]=c[0]/c[3],c[1]=c[1]/c[3],c[0]=(.5*c[0]+.5)*this.engine.width,c[1]=(-.5*c[1]+.5)*this.engine.height,c[0]=c[0]<0?0:c[0],c[1]=c[1]<0?0:c[1],c[0]=c[0]>this.engine.width?this.engine.width:c[0],c[1]=c[1]>this.engine.height?this.engine.height:c[1],c[0]<n[0]?n[0]=c[0]:c[0]>r[0]&&(r[0]=c[0]),c[1]<n[1]?n[1]=c[1]:c[1]>r[1]&&(r[1]=c[1]),c[2]>r[2]&&(r[2]=c[2])}this.relativeToCameraPosition={max:{x:r[0],y:r[1]},min:{x:n[0],y:n[1]},depth:r[2]}}},{key:"getPositionOnScreen",value:function(){this.updateRelativeToCameraPosition(),this.engine.controls.mouse.x>this.relativeToCameraPosition.min.x&&this.engine.controls.mouse.x<this.relativeToCameraPosition.max.x&&this.engine.controls.mouse.y>this.relativeToCameraPosition.min.y&&this.engine.controls.mouse.y<this.relativeToCameraPosition.max.y&&(null==this.engine.selectedObject||this.engine.selectedObject.relativeToCameraPosition.depth>=this.relativeToCameraPosition.depth)&&(this.engine.selectedObject=this)}},{key:"updateMatrixes",value:function(){var e=q(this.rotation.x,this.rotation.y,this.rotation.z),t=D(this._position.x,this._position.y,this._position.z);this.verticalAlign||(t=Z(t,D(0,-(this.maxSize.y-this.minSize.y)/2,0)));var i=e;i=Z(i=Z(i,D(-this.minSize.x-(this.maxSize.x-this.minSize.x)/2,-this.minSize.y-(this.maxSize.y-this.minSize.y)/2,-this.minSize.z-(this.maxSize.z-this.minSize.z)/2)),W(this.scaling.x,this.scaling.y,this.scaling.z)),t=this.UIElement?(this.uiMatrix=Z(t,i),Z(this.camera.matrix,e)):Z(t,i),this.worldMatrix=t,this.rotationMatrix=e}},{key:"update",value:function(){if(!this.hidden){var e=z(this.engine.camera.fieldOfViewRad,this.engine.width,this.engine.height,1,this.engine.camera.range);this.UIElement?(e=Z(e,this.uiMatrix),this.rotationMatrix=Z(this.engine.camera.rotationMatrix,this.rotationMatrix)):e=Z(e=Z(e,this.engine.camera.inverseMatrix),this.worldMatrix),this.matrix=e}this.selectable&&this.getPositionOnScreen()}},{key:"draw",value:function(){!this.hidden&&this.shaderProgram&&(this.shaderProgram.use(),this.engine.webgl.enableVertexAttribArray(this.shaderProgram.positionLocation),this.engine.webgl.bindBuffer(this.engine.webgl.ARRAY_BUFFER,this.vertexesBuffer),this.engine.webgl.vertexAttribPointer(this.shaderProgram.positionLocation,3,this.engine.webgl.FLOAT,!1,0,0),this.engine.webgl.enableVertexAttribArray(this.shaderProgram.texcoordLocation),this.engine.webgl.bindBuffer(this.engine.webgl.ARRAY_BUFFER,this.textureCoordinatesBuffer),this.engine.webgl.vertexAttribPointer(this.shaderProgram.texcoordLocation,2,this.engine.webgl.FLOAT,!1,0,0),this.engine.webgl.enableVertexAttribArray(this.shaderProgram.normalLocation),this.engine.webgl.bindBuffer(this.engine.webgl.ARRAY_BUFFER,this.normalsBuffer),this.engine.webgl.vertexAttribPointer(this.shaderProgram.normalLocation,3,this.engine.webgl.FLOAT,!1,0,0),this.engine.webgl.uniform1i(this.shaderProgram.textureLocation,this.texture.textureBlockLocation),this.engine.webgl.uniformMatrix4fv(this.shaderProgram.matrixLocation,!1,this.matrix),this.engine.webgl.uniformMatrix4fv(this.shaderProgram.objectRotationLocation,!1,this.rotationMatrix),this.engine.webgl.uniformMatrix4fv(this.shaderProgram.worldMatrixLocation,!1,this.worldMatrix),this.engine.webgl.drawArrays(this.engine.webgl.TRIANGLES,0,this.vertexes.length/3))}},{key:"animate",value:function(e,t){var i=this;return t=t,this._animationInterval=setInterval(function(){t(i)},1e3/e),this._animationInterval}},{key:"hide",value:function(){this.hidden=!0}},{key:"show",value:function(){this.hidden=!1}},{key:"destroy",value:function(){this.engine.removeObject(this)}},{key:"engine",get:function(){return this._engine}},{key:"position",get:function(){return this._position},set:function(e){this._position=e,this._UIElement?this._position.set(this.engine.width/100*e.x,-this.engine.height/100*e.y,e.z):this._position=e}},{key:"UIElement",set:function(e){this._UIElement=e,null!=this.engine.ui?e?this.engine.ui.addObject(this):this.engine.ui.removeObject(this):new ke("UI not set for engine.")},get:function(){return this._UIElement}},{key:"collisionBox",get:function(){if(!this._collisionBox)throw new ke("Collision box is null");return this._collisionBox}},{key:"size",get:function(){return{base:{max:this.maxBaseSize,min:this.minBaseSize},current:{max:this.maxSize,min:this.minSize}}}}]),t}(),Qe=function(){function e(){We(this,e),Je(this,"maxPoint",new g(0,0,0)),Je(this,"minPoint",new g(0,0,0)),Je(this,"points",[])}return Ze(e,[{key:"generatePoints",value:function(){}}]),e}(),$e=Ke;function et(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function tt(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var it=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),tt(this,"fieldOfView",90),tt(this,"fieldOfViewRad",u(90)),tt(this,"rotation",new g(0,0,0)),tt(this,"range",2e4),tt(this,"matrix",[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),tt(this,"rotationMatrix",[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),tt(this,"inverseMatrix",[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),tt(this,"inverseRotationMatrix",[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),tt(this,"moved",!1),tt(this,"moving",new g(0,0,0)),tt(this,"animatedMoving",new g(0,0,0)),tt(this,"collisionBox",new Qe),tt(this,"collisions",!0),tt(this,"engine",void 0),tt(this,"_position",new g(0,400,500)),this.engine=e}return function(e,t,i){t&&et(e.prototype,t),i&&et(e,i)}(t,[{key:"setCubeCollisionBox",value:function(e){var t=e/2;this.collisionBox.minPoint.x=-t,this.collisionBox.minPoint.y=-t,this.collisionBox.minPoint.z=-t,this.collisionBox.maxPoint.x=t,this.collisionBox.maxPoint.y=t,this.collisionBox.maxPoint.z=t}},{key:"setFieldOfView",value:function(e){this.fieldOfView=e,this.fieldOfViewRad=u(e)}},{key:"setCollisions",value:function(e){this.collisions=e}},{key:"onCollision",value:function(e){this.moving.x=0,this.moving.y=0,this.moving.z=0}},{key:"setPosition",value:function(e,t,i){this.position.set(e,t,i)}},{key:"move",value:function(e,t,i){this.moving.move(e,t,i),this.moved=!0}},{key:"moveAnimate",value:function(e,t,i){var n=this,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:100,o=new g(e/=r,t/=r,i/=r);this.animatedMoving.add(o);var s=r,a=this.engine.addOnFrameHandler(function(){(s-=1)<=0&&(n.engine.removeOnFrameHandler(a),n.animatedMoving.sub(o))})}},{key:"rotate",value:function(e,t,i){this.rotation.x+=e,this.rotation.y+=t,this.rotation.z+=i,this.computeMatrix()}},{key:"setRotation",value:function(e,t,i){this.rotation.set(e,t,i),this.computeMatrix()}},{key:"computeMatrix",value:function(){this.matrix=D(this.position.x,this.position.y,this.position.z);var e=Y(u(this.rotation.y));e=Z(e=Z(e,H(u(this.rotation.x))),V(u(this.rotation.z))),this.matrix=Z(this.matrix,e),this.rotationMatrix=e,this.inverseRotationMatrix=$(e),this.inverseMatrix=$(this.matrix)}},{key:"position",get:function(){return this._position},set:function(e){this._position=e,this.computeMatrix()}}]),t}();function nt(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function rt(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ot(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var st=function(){function n(s){var a=this;nt(this,n),ot(this,"engine",void 0),ot(this,"isFocused",!1),ot(this,"keys",[]),ot(this,"mouseOverCanvas",!1),ot(this,"pointerLocked",!1),ot(this,"mouse",new at),ot(this,"touch",new ut),ot(this,"longTouchTime",500),ot(this,"touchDuration",100),ot(this,"controlFunction",null),ot(this,"_lockPointer",!1),ot(this,"_rebind",!0),ot(this,"_globalRebind",!1),ot(this,"_handlers",[]),ot(this,"_focusHandlers",[]),ot(this,"_blurHandlers",[]),ot(this,"_focusOnlyIfClick",!0),ot(this,"_mouseDownHandlers",[null,null,null,null,null,null]),ot(this,"_mouseUpHandlers",[null,null,null,null,null,null]),(s.controls=this).engine=s;for(var e=0;e<255;e++)this.keys[e]=!1,this._handlers[e]=null;if(window.onkeydown=function(e){return a.isFocused?(27==e.keyCode&&s.div.blur(),a.keys[e.keyCode]=!0,null!=a._handlers[e.keyCode]&&a._handlers[e.keyCode](e),!a._rebind):!a._globalRebind||!a._rebind},window.onkeyup=function(e){return a.keys[e.keyCode]=!1,!a._rebind},s.div.setAttribute("tabindex","0"),s.div.onblur=function(){a.isFocused=!1;for(var e=0;e<a._blurHandlers.length;e++)a._blurHandlers[e]()},s.div.onfocus=function(){a.isFocused=!0;for(var e=0;e<a._focusHandlers.length;e++)a._focusHandlers[e]()},s.div.onclick=function(){a._focusOnlyIfClick&&!a.isFocused&&s.div.focus(),a._lockPointer&&s.div.requestPointerLock()},s.div.oncontextmenu=function(){return!1},function(){var e=" -webkit- -moz- -o- -ms- ".split(" ");if("ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch)return!0;var t=["(",e.join("touch-enabled),("),"heartz",")"].join("");return function(e){return window.matchMedia(e).matches}(t)}()){var t,u,i=function(){a.touch.duration=(new Date).getTime()-t,a.touch.duration>a.longTouchTime&&(a.touch.longClick=!0,a.touch.click=!1,clearInterval())},h=!1;s.div.addEventListener("touchstart",function(e){return null!=a._mouseDownHandlers[2]&&a._mouseDownHandlers[2](e),u=setInterval(i,100),t=(new Date).getTime(),a.touch.duration=0,h=!1},!1),s.div.addEventListener("touchend",function(e){return!h&&a.touch.duration<a.longTouchTime?(a.touch.click=!0,setTimeout(function(){a.touch.click=!1},100)):a.touch.actionBeforeMove=null,l=null,a.touch.longClick=!1,clearInterval(u),!1},!1);var l=null;s.div.addEventListener("touchmove",function(e){var t=s.div.getBoundingClientRect(),i=e.touches[0].clientX-t.left,n=e.touches[0].clientY-t.top;a.mouse.x=i,a.mouse.y=n,null==l&&(l=new A(i,n));var r=(i-l.x)*a.mouse.sensitivity,o=(n-l.y)*a.mouse.sensitivity;a.mouse.movement.x=r,a.mouse.movement.y=o,l.x=i,l.y=n,a.touch.x=i,a.touch.y=n,a.touch.movement.x=r,a.touch.movement.y=o,h||(a.touch.duration>a.longTouchTime?(a.touch.actionBeforeMove="long click",a.touch.longClick=!1):(a.touch.actionBeforeMove="click",a.touch.click=!1)),h=!0,clearInterval(u)},!1)}else{var r=null;s.div.addEventListener("mousemove",function(e){if(a.isFocused)if(a.pointerLocked)a.mouse.movement.x=-e.movementX*a.mouse.sensitivity,a.mouse.movement.y=-e.movementY*a.mouse.sensitivity,a.mouse.x=a.engine.width/2,a.mouse.y=a.engine.height/2;else{var t=s.div.getBoundingClientRect(),i=e.clientX-t.left,n=e.clientY-t.top;a.mouse.x=i,a.mouse.y=n,null==r&&(r=new A(i,n)),a.mouse.movement.x=(i-r.x)*a.mouse.sensitivity,a.mouse.movement.y=(n-r.y)*a.mouse.sensitivity,r.x=i,r.y=n}},!1),window.addEventListener("mousemove",function(e){var t=s.div.getBoundingClientRect(),i=e.clientX,n=e.clientY;i<t.right&&i>t.left&&n<t.bottom&&n>t.top?(a.mouseOverCanvas=!0,a._focusOnlyIfClick||a.isFocused||s.div.focus()):(a.mouseOverCanvas=!1,a._focusOnlyIfClick||s.div.blur())}),s.div.onmousedown=function(e){if(a.isFocused)return a.mouse.buttons[e.button]=!0,null!=a._mouseDownHandlers[2+e.button]&&a._mouseDownHandlers[2+e.button](e),!1},s.div.onmouseup=function(e){return a.mouse.buttons[e.button]=!1,null!=a._mouseUpHandlers[2+e.button]&&a._mouseUpHandlers[2+e.button](e),!1},document.addEventListener("pointerlockchange",function(){document.pointerLockElement===s.div?(s.div.focus(),a.pointerLocked=!0):(s.div.blur(),a.pointerLocked=!1)},!1)}}return function(e,t,i){t&&rt(e.prototype,t),i&&rt(e,i)}(n,[{key:"clickForFocus",value:function(e){e=e||!this._focusOnlyIfClick,this._focusOnlyIfClick=e}},{key:"setSensitivity",value:function(e){this.mouse.sensitivity=e}},{key:"rebindDefaultBrowserActions",value:function(e){e=e||!this._rebind,this._rebind=e}},{key:"globalRebind",value:function(e){e=e||!this._globalRebind,this._globalRebind=e}},{key:"addOnFocusHandler",value:function(e){this._focusHandlers.push(e)}},{key:"addOnBlurHandler",value:function(e){this._blurHandlers.push(e)}},{key:"onKeyDown",value:function(e,t){this._handlers[e]=t}},{key:"onMouseDown",value:function(e,t){this._mouseDownHandlers[2+e]=t}},{key:"onMouseUp",value:function(e,t){this._mouseUpHandlers[2+e]=t}},{key:"onMouseMove",value:function(e){this.engine.div.addEventListener("mousemove",e,!1)}},{key:"onContextMenu",value:function(e){this.engine.div.oncontextmenu=e}},{key:"lockPointer",value:function(e){e=e||!this._lockPointer,this._lockPointer=e}},{key:"setControlFunction",value:function(e){this.controlFunction=e}}]),n}(),at=function e(){nt(this,e),ot(this,"x",0),ot(this,"y",0),ot(this,"movement",new A(0,0)),ot(this,"click",!1),ot(this,"longClick",!1),ot(this,"duration",null),ot(this,"actionBeforeMove",null),ot(this,"sensitivity",1),ot(this,"buttons",[!1,!1,!1])},ut=function e(){nt(this,e),ot(this,"x",0),ot(this,"y",0),ot(this,"movement",new A(0,0)),ot(this,"click",!1),ot(this,"longClick",!1),ot(this,"duration",null),ot(this,"actionBeforeMove",null)};function ht(e){return(ht="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function lt(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ct(e){return(ct=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ft(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function gt(e,t){return(gt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function dt(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var bt=function(e){function r(e,t){var i;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),dt(ft(i=function(e,t){return!t||"object"!==ht(t)&&"function"!=typeof t?ft(e):t}(this,ct(r).call(this,e))),"textureBlockLocation",-1),dt(ft(i),"mipmapFilter","LINEAR"),dt(ft(i),"AUTO_GENERATE",0),dt(ft(i),"QUICK_GENERATE",1),dt(ft(i),"_mipmap",[]),dt(ft(i),"_onTextureLoadedHandlers",[]),dt(ft(i),"_width",-1),dt(ft(i),"_height",-1),dt(ft(i),"_image",new Image),dt(ft(i),"_mipmapGenerationMethod",-1),i.engine=e,i.textureBlockLocation=i.engine.textures.length,i.engine.textures.push(ft(i));var n=i.engine.webgl;return i.webglTexture=n.createTexture(),n.activeTexture(n.TEXTURE0+i.textureBlockLocation),n.bindTexture(n.TEXTURE_2D,i.webglTexture),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,1,1,0,n.RGBA,n.UNSIGNED_BYTE,i.color),i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&gt(e,t)}(r,je),function(e,t,i){t&&lt(e.prototype,t),i&&lt(e,i)}(r,[{key:"setMipmapGenerationMethod",value:function(e){this._mipmapGenerationMethod=e}},{key:"setSize",value:function(e,t){this.width=e,this.height=t,this._image.width=e,this._image.height=t,this.loaded&&this._createWebglTexture()}},{key:"_createWebglTexture",value:function(){var e,i=this.engine.webgl;i.activeTexture(i.TEXTURE0+this.textureBlockLocation);var t=!0;switch(this.mipmapFilter){case"NEAREST":e=i.NEAREST,t=!1;break;case"LINEAR":e=i.LINEAR,t=!1;break;case"NEAREST_MIPMAP_NEAREST":e=i.NEAREST_MIPMAP_NEAREST;break;case"LINEAR_MIPMAP_NEAREST":case"NEAREST_MIPMAP_LINEAR":e=i.LINEAR_MIPMAP_NEAREST;break;case"LINEAR_MIPMAP_LINEAR":e=i.LINEAR_MIPMAP_LINEAR;break;default:t=!1,e=i.LINEAR}if(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,e),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),this._mipmapGenerationMethod==this.QUICK_GENERATE){if(this.width/this.height!=2)return console.warn("Wrong _image sizes for quick generation _mipmap.");for(var n=this.height,r=0;;){var o=document.createElement("canvas");if(o.width=n,o.height=n,o.getContext("2d").drawImage(this._image,r,0,n,n,0,0,n,n),this._mipmap.push(o),1==n)break;r+=n,n/=2}}t&&this._mipmapGenerationMethod!=this.AUTO_GENERATE?0<this._mipmap.length?this._mipmap.forEach(function(e,t){i.texImage2D(i.TEXTURE_2D,t,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e)}):(console.warn("Need to generate mipmaps for texture:"),console.warn(this)):i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,this._image),(t||this._mipmapGenerationMethod==this.AUTO_GENERATE)&&h(this._width)&&h(this._height)?i.generateMipmap(i.TEXTURE_2D):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE))}},{key:"loadFrom",value:function(e){var t=this;this._image.src=e,this._image.addEventListener("load",function(){t.engine.textureLoaded(t),t.loaded=!0;for(var e=0;e<t._onTextureLoadedHandlers.length;e++)t._onTextureLoadedHandlers[e]();-1!=t._height&&-1!=t._width||(t._height=t._image.height,t._width=t._image.width),t._createWebglTexture()})}},{key:"image",get:function(){return this._image}},{key:"height",set:function(e){this._height=e,this._image.height=e},get:function(){return this._height}},{key:"width",set:function(e){this._width=e,this._image.width=e},get:function(){return this._width}}]),r}();function mt(e){return(mt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function vt(e){return(vt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _t(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function wt(e,t){return(wt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function yt(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function pt(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function xt(e,t,i){return t&&pt(e.prototype,t),i&&pt(e,i),e}function Et(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var Tt=function(){function i(e){yt(this,i),Et(this,"canvas",void 0),Et(this,"div",void 0),Et(this,"width",void 0),Et(this,"height",void 0),Et(this,"centerX",void 0),Et(this,"centerY",void 0),Et(this,"context",void 0),Et(this,"objects",void 0),Et(this,"htmlElements",void 0),Et(this,"engine",void 0),Et(this,"Screen",Rt),Et(this,"images",[]),Et(this,"webgl",void 0),Et(this,"_screen",void 0),Et(this,"_texture",void 0),Et(this,"_webglTexture",void 0),Et(this,"frameBuffer",void 0),this.width=e.div.offsetWidth,this.height=e.div.offsetHeight,this.canvas=document.createElement("canvas"),this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.style.position="absolute",this.canvas.style.height="100%",this.canvas.style.width="100%",this.canvas.style.zIndex="999999",this.canvas.style.left="0",this.canvas.style.right="0",this.canvas.style.top="0",this.div=document.createElement("div"),this.div.style.position="absolute",this.div.style.height="100%",this.div.style.width="100%",this.div.style.zIndex="999999",this.div.style.left="0",this.div.style.right="0",this.div.style.top="0",e.div.appendChild(this.canvas),e.div.appendChild(this.div),this.centerX=this.width/2,this.centerY=this.height/2,this.context=this.canvas.getContext("2d"),this.objects=[],this.htmlElements=[],(e.ui=this).engine=e,this.webgl=e.webgl,this._screen=new Rt(this.engine),this._texture={_textureBlockLocation:this.engine.textures.length},this.engine.textures.push(this._texture),this.engine.textureLoaded(this._texture),this.engine.webgl.activeTexture(this.engine.webgl.TEXTURE0+this._texture._textureBlockLocation),this._webglTexture=this.webgl.createTexture(),this.webgl.bindTexture(this.webgl.TEXTURE_2D,this._webglTexture),this.webgl.texImage2D(this.webgl.TEXTURE_2D,0,this.webgl.RGBA,this.width,this.height,0,this.webgl.RGBA,this.webgl.UNSIGNED_BYTE,null),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_MAG_FILTER,this.webgl.NEAREST),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_MIN_FILTER,this.webgl.NEAREST),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_S,this.webgl.CLAMP_TO_EDGE),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_T,this.webgl.CLAMP_TO_EDGE),this.frameBuffer=this.webgl.createFramebuffer(),this.webgl.bindFramebuffer(this.webgl.FRAMEBUFFER,this.frameBuffer),this.webgl.framebufferTexture2D(this.webgl.FRAMEBUFFER,this.webgl.COLOR_ATTACHMENT0,this.webgl.TEXTURE_2D,this._webglTexture,0);var t=this.webgl.createRenderbuffer();this.webgl.bindRenderbuffer(this.webgl.RENDERBUFFER,t),this.webgl.renderbufferStorage(this.webgl.RENDERBUFFER,this.webgl.DEPTH_COMPONENT16,this.width,this.height),this.webgl.framebufferRenderbuffer(this.webgl.FRAMEBUFFER,this.webgl.DEPTH_ATTACHMENT,this.webgl.RENDERBUFFER,t),this.webgl.bindFramebuffer(this.webgl.FRAMEBUFFER,null)}return xt(i,[{key:"addObject",value:function(e){this.objects.push(e),this.engine.removeObject(e)}},{key:"removeObject",value:function(e){var t=this.objects.indexOf(e);-1!=t?(this.objects.splice(t,1),this.engine.addObject(e)):console.warn("Object not found")}},{key:"appendDOMElement",value:function(e,t){return this.div.appendChild(e),this.htmlElements.push(new At(t,e)),e}},{key:"addImage",value:function(e,t,i,n,r){e.width=t,e.height=i;var o=new Pt("",e,n,r,t,i);return this.images.push(o),this.images[this.images.length-1]}},{key:"hide",value:function(e){e instanceof bt?e=e.image:e instanceof At&&(e.hidden=!0,e=e.el),e.style.display="none"}},{key:"show",value:function(e){e instanceof bt?e=e.image:e instanceof At&&(e.hidden=!1,e=e.el),e.style.display="block"}},{key:"drawImage",value:function(e){this.context.drawImage(e,0,0)}},{key:"clearCanvas",value:function(){this.context.clearRect(0,0,this.width,this.height)}},{key:"draw",value:function(){var i=this,e=this.engine.webgl;e.bindFramebuffer(e.FRAMEBUFFER,this.frameBuffer),e.enable(this.webgl.CULL_FACE),e.enable(this.webgl.DEPTH_TEST),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.viewport(0,0,this.engine.width,this.engine.height),this.context.clearRect(0,0,this.width,this.height),this.images.forEach(function(e){if(!e.hidden&&e.el instanceof HTMLImageElement){var t=e.el;i.context.drawImage(t,e.x,e.y,e.width,e.height)}}),this.objects.forEach(function(e){e.draw()}),this._screen.setTexture(this._texture),e.bindFramebuffer(e.FRAMEBUFFER,null),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}},{key:"drawUI",value:function(){this._screen.draw()}}]),i}(),Rt=function(){function t(e){yt(this,t),Et(this,"webgl",void 0),Et(this,"engine",void 0),Et(this,"shaderProgram",void 0),Et(this,"vertexes",void 0),Et(this,"textureCoords",void 0),Et(this,"vertexesBuffer",void 0),Et(this,"coordsBuffer",void 0),Et(this,"normalBuffer",void 0),Et(this,"texture",void 0),this.webgl=e.webgl,this.engine=e,this.shaderProgram=e.shaders.screen,this.webgl.enable(this.webgl.CULL_FACE),this.webgl.enable(this.webgl.DEPTH_TEST),this.vertexes=[-1,-1,-1,1,1,-1,-1,1,-1,1,1,-1,-1,-1,-1,1,-1,-1],this.textureCoords=[0,0,1,1,0,1,1,1,0,0,1,0],this.vertexesBuffer=this.webgl.createBuffer(),this.webgl.bindBuffer(this.webgl.ARRAY_BUFFER,this.vertexesBuffer),this.webgl.bufferData(this.webgl.ARRAY_BUFFER,new Float32Array(this.vertexes),this.webgl.STATIC_DRAW),this.coordsBuffer=this.webgl.createBuffer(),this.webgl.bindBuffer(this.webgl.ARRAY_BUFFER,this.coordsBuffer),this.webgl.bufferData(this.webgl.ARRAY_BUFFER,new Float32Array(this.textureCoords),this.webgl.STATIC_DRAW)}return xt(t,[{key:"setTexture",value:function(e){this.texture=e}},{key:"draw",value:function(){this.webgl.bindFramebuffer(this.webgl.FRAMEBUFFER,null),this.shaderProgram.use(),this.engine.webgl.enableVertexAttribArray(this.shaderProgram.positionLocation),this.engine.webgl.bindBuffer(this.engine.webgl.ARRAY_BUFFER,this.vertexesBuffer),this.engine.webgl.vertexAttribPointer(this.shaderProgram.positionLocation,3,this.engine.webgl.FLOAT,!1,0,0),this.engine.webgl.enableVertexAttribArray(this.shaderProgram.texcoordLocation),this.engine.webgl.bindBuffer(this.engine.webgl.ARRAY_BUFFER,this.coordsBuffer),this.engine.webgl.vertexAttribPointer(this.shaderProgram.texcoordLocation,2,this.engine.webgl.FLOAT,!1,0,0),this.engine.webgl.uniform1i(this.shaderProgram.textureLocation,this.texture._textureBlockLocation),this.engine.webgl.drawArrays(this.engine.webgl.TRIANGLES,0,this.vertexes.length/3)}}]),t}(),At=function(){function i(e,t){yt(this,i),Et(this,"name",void 0),Et(this,"el",void 0),Et(this,"hidden",!1),this.name=e,this.el=t}return xt(i,[{key:"hide",value:function(){this.el.style.display="none",this.hidden=!0}},{key:"show",value:function(){this.el.style.display="block",this.hidden=!1}}]),i}(),Pt=function(e){function a(e,t,i,n,r,o){var s;return yt(this,a),Et(_t(s=function(e,t){return!t||"object"!==mt(t)&&"function"!=typeof t?_t(e):t}(this,vt(a).call(this,e,t))),"x",0),Et(_t(s),"y",0),Et(_t(s),"width",0),Et(_t(s),"height",0),s.x=i,s.y=n,s.width=r,s.height=o,s}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&wt(e,t)}(a,At),a}();function St(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Bt(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var kt=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),Bt(this,"logArray",void 0),Bt(this,"element",void 0),(e.debugger=this).logArray=[],this.element=null}return function(e,t,i){t&&St(e.prototype,t),i&&St(e,i)}(t,[{key:"setElement",value:function(e){this.element=e}},{key:"addLog",value:function(e,t){this.logArray.push({view:e,output:t}),this.addView(e)}},{key:"createLogView",value:function(){return document.createElement("p")}},{key:"addView",value:function(e){this.element.appendChild(e)}},{key:"updateInfo",value:function(){this.logArray.forEach(function(e){e.view.innerText=e.output(e)})}}]),t}();function Lt(e){return(Lt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ct(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Ot(e){return(Ot=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function It(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Mt(e,t){return(Mt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function jt(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var Ft=function(e){function i(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),jt(It(t=function(e,t){return!t||"object"!==Lt(t)&&"function"!=typeof t?It(e):t}(this,Ot(i).call(this,e))),"textures",void 0),jt(It(t),"_onTextureLoad",void 0),jt(It(t),"webgl",void 0),jt(It(t),"_loadedTextureCount",0),t.engine=e,t.engine.textures.push(It(t)),t.webgl=e.webgl,t.textureBlockLocation=t.engine.textures.length,t.webglTexture=t.engine.webgl.createTexture(),t.engine.webgl.activeTexture(t.engine.webgl.TEXTURE0+t.textureBlockLocation),t.engine.webgl.bindTexture(t.engine.webgl.TEXTURE_2D,t.webglTexture),t.engine.webgl.texImage2D(t.engine.webgl.TEXTURE_2D,0,t.engine.webgl.RGBA,1,1,0,t.engine.webgl.RGBA,t.engine.webgl.UNSIGNED_BYTE,t.color),t._onTextureLoad=[],t.loaded=!1,t.textures={positiveX:null,negativeX:null,positiveY:null,negativeY:null,positiveZ:null,negativeZ:null},t._loadedTextureCount=0,t}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Mt(e,t)}(i,je),function(e,t,i){t&&Ct(e.prototype,t),i&&Ct(e,i)}(i,[{key:"setImagesFromPath",value:function(e,t,i,n,r,o){var s=this;this.textures.positiveX=new Image,this.textures.positiveX.crossOrigin="",this.textures.positiveX.onload=function(){s._loadedTextureCount++,6==s._loadedTextureCount&&(s.loaded=!0,s._onTextureLoad.forEach(function(e){e(s)}),s.bindCubeTexture())},this.textures.positiveX.src=e,this.textures.negativeX=new Image,this.textures.negativeX.crossOrigin="",this.textures.negativeX.src=t,this.textures.negativeX.onload=function(){s._loadedTextureCount++,6==s._loadedTextureCount&&(s.loaded=!0,s._onTextureLoad.forEach(function(e){e(s)}),s.bindCubeTexture())},this.textures.positiveY=new Image,this.textures.positiveY.crossOrigin="",this.textures.positiveY.src=i,this.textures.positiveY.onload=function(){s._loadedTextureCount++,6==s._loadedTextureCount&&(s.loaded=!0,s._onTextureLoad.forEach(function(e){e(s)}),s.bindCubeTexture())},this.textures.negativeY=new Image,this.textures.negativeY.crossOrigin="",this.textures.negativeY.src=n,this.textures.negativeY.onload=function(){s._loadedTextureCount++,6==s._loadedTextureCount&&(s.loaded=!0,s._onTextureLoad.forEach(function(e){e(s)}),s.bindCubeTexture())},this.textures.positiveZ=new Image,this.textures.positiveZ.crossOrigin="",this.textures.positiveZ.src=r,this.textures.positiveZ.onload=function(){s._loadedTextureCount++,6==s._loadedTextureCount&&(s.loaded=!0,s._onTextureLoad.forEach(function(e){e(s)}),s.bindCubeTexture())},this.textures.negativeZ=new Image,this.textures.negativeZ.crossOrigin="",this.textures.negativeZ.src=o,this.textures.negativeZ.onload=function(){s._loadedTextureCount++,6==s._loadedTextureCount&&(s.loaded=!0,s._onTextureLoad.forEach(function(e){e(s)}),s.bindCubeTexture())}}},{key:"setLoadingImages",value:function(e,t,i,n,r,o){for(var s=this,a=0;a<arguments.length-1;a++)if(arguments[a].width!=arguments[a].height||arguments[a].height!=arguments[a+1].height||arguments[a+1].width!=arguments[a+1].height)throw"Sizes of textures not are the same or texture isnt square.";this.textures.positiveX=this.engine.noTexture.webglTexture,e.addEventListener("load",function(){s.textures.positiveX=e,s._loadedTextureCount++,6==s._loadedTextureCount&&(s.loaded=!0,s._onTextureLoad.forEach(function(e){e(s)}),s.bindCubeTexture())}),this.textures.negativeX=this.engine.noTexture.webglTexture,t.addEventListener("load",function(){s.textures.negativeX=t,s._loadedTextureCount++,6==s._loadedTextureCount&&(s.loaded=!0,s._onTextureLoad.forEach(function(e){e(s)}),s.bindCubeTexture())}),this.textures.positiveY=this.engine.noTexture.webglTexture,i.addEventListener("load",function(){s.textures.positiveY=i,s._loadedTextureCount++,6==s._loadedTextureCount&&(s.loaded=!0,s._onTextureLoad.forEach(function(e){e(s)}),s.bindCubeTexture())}),this.textures.negativeY=this.engine.noTexture.webglTexture,n.addEventListener("load",function(){s.textures.negativeY=n,s._loadedTextureCount++,6==s._loadedTextureCount&&(s.loaded=!0,s._onTextureLoad.forEach(function(e){e(s)}),s.bindCubeTexture())}),this.textures.positiveZ=this.engine.noTexture.webglTexture,r.addEventListener("load",function(){s.textures.positiveZ=r,s._loadedTextureCount++,6==s._loadedTextureCount&&(s.loaded=!0,s._onTextureLoad.forEach(function(e){e(s)}),s.bindCubeTexture())}),this.textures.negativeZ=this.engine.noTexture.webglTexture,o.addEventListener("load",function(){s.textures.negativeZ=o,s._loadedTextureCount++,6==s._loadedTextureCount&&(s.loaded=!0,s._onTextureLoad.forEach(function(e){e(s)}),s.bindCubeTexture())})}},{key:"setLoadedImages",value:function(e,t,i,n,r,o){this.textures.positiveX=e,this.textures.negativeX=t,this.textures.positiveY=i,this.textures.negativeY=n,this.textures.positiveZ=r,this.textures.negativeZ=o,this.loaded=!0,this.bindCubeTexture()}},{key:"setSkybox",value:function(e){var o=this,s=new Image;s.crossOrigin="",s.src=e,s.onload=function(){var e,t=s.width,i=s.height;if(i/3!=t/4)throw"Wrong sizes for texture. Texture must be Skyblock 3x4 squares.";e=i/3;var n=document.createElement("canvas");n.height=e,n.width=e;var r=n.getContext("2d");r.drawImage(s,0,e,e,e,0,0,e,e),o.textures.negativeX=n,(n=document.createElement("canvas")).height=e,n.width=e,(r=n.getContext("2d")).drawImage(s,2*e,e,e,e,0,0,e,e),o.textures.positiveX=n,(n=document.createElement("canvas")).height=e,n.width=e,(r=n.getContext("2d")).drawImage(s,e,e,e,e,0,0,e,e),o.textures.positiveZ=n,(n=document.createElement("canvas")).height=e,n.width=e,(r=n.getContext("2d")).drawImage(s,3*e,e,e,e,0,0,e,e),o.textures.negativeZ=n,(n=document.createElement("canvas")).height=e,n.width=e,(r=n.getContext("2d")).drawImage(s,e,0,e,e,0,0,e,e),o.textures.positiveY=n,(n=document.createElement("canvas")).height=e,n.width=e,(r=n.getContext("2d")).drawImage(s,e,2*e,e,e,0,0,e,e),o.textures.negativeY=n,o.loaded=!0,o._onTextureLoad.forEach(function(e){e(o)}),o.bindCubeTexture()}}},{key:"bindCubeTexture",value:function(){this.engine.webgl.activeTexture(this.engine.webgl.TEXTURE0+this.textureBlockLocation),this.webglTexture=this.webgl.createTexture(),this.webgl.bindTexture(this.webgl.TEXTURE_CUBE_MAP,this.webglTexture),this.webgl.texImage2D(this.webgl.TEXTURE_CUBE_MAP_POSITIVE_X,0,this.webgl.RGBA,this.webgl.RGBA,this.webgl.UNSIGNED_BYTE,this.textures.positiveX),this.webgl.texImage2D(this.webgl.TEXTURE_CUBE_MAP_NEGATIVE_X,0,this.webgl.RGBA,this.webgl.RGBA,this.webgl.UNSIGNED_BYTE,this.textures.negativeX),this.webgl.texImage2D(this.webgl.TEXTURE_CUBE_MAP_POSITIVE_Y,0,this.webgl.RGBA,this.webgl.RGBA,this.webgl.UNSIGNED_BYTE,this.textures.positiveY),this.webgl.texImage2D(this.webgl.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,this.webgl.RGBA,this.webgl.RGBA,this.webgl.UNSIGNED_BYTE,this.textures.negativeY),this.webgl.texImage2D(this.webgl.TEXTURE_CUBE_MAP_POSITIVE_Z,0,this.webgl.RGBA,this.webgl.RGBA,this.webgl.UNSIGNED_BYTE,this.textures.positiveZ),this.webgl.texImage2D(this.webgl.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,this.webgl.RGBA,this.webgl.RGBA,this.webgl.UNSIGNED_BYTE,this.textures.negativeZ),this.webgl.generateMipmap(this.webgl.TEXTURE_CUBE_MAP),this.webgl.texParameteri(this.webgl.TEXTURE_CUBE_MAP,this.webgl.TEXTURE_MIN_FILTER,this.webgl.LINEAR_MIPMAP_LINEAR),this.engine.textureLoaded(this),this.loaded=!0}}]),i}();function zt(e){return(zt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ut(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Dt(e){return(Dt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Gt(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Nt(e,t){return(Nt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Xt(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var Ht=[],Yt=0,Vt=function(e){function u(e,t,i,n){var r;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u),Xt(Gt(r=function(e,t){return!t||"object"!==zt(t)&&"function"!=typeof t?Gt(e):t}(this,Dt(u).call(this,e))),"_background",void 0),Xt(Gt(r),"_quality",void 0),Xt(Gt(r),"_reflectionAlpha",-1),Xt(Gt(r),"_object",void 0),Xt(Gt(r),"_camera",void 0),Ht.push(Gt(r)),e.reflections=!0,r.alpha=!0,r.loaded=!1,r._background=t||"rgba(0, 0, 0, 0)",r._quality=i||512,r._object=null;var o=document.createElement("canvas"),s=o.getContext("2d");if(o.width=16,o.height=16,"string"==typeof t){if(n)r._reflectionAlpha=Number(n);else{var a=t.replace("rgba(","");a=(a=a.replace(")","")).split(",")[3],r._reflectionAlpha=Number(a)}s.fillStyle=t,s.fillRect(0,0,16,16)}else t.constructor===HTMLImageElement&&(r._reflectionAlpha=n?Number(n):1,o.width=Number(t.width),o.height=Number(t.height),s.drawImage(t,0,0,t.width,t.height));return r.webglTexture=r.webgl.createTexture(),r.webgl.bindTexture(r.webgl.TEXTURE_CUBE_MAP,r.webglTexture),r.webgl.texImage2D(r.webgl.TEXTURE_CUBE_MAP_POSITIVE_X,0,r.webgl.RGBA,r.webgl.RGBA,r.webgl.UNSIGNED_BYTE,o),r.webgl.texImage2D(r.webgl.TEXTURE_CUBE_MAP_NEGATIVE_X,0,r.webgl.RGBA,r.webgl.RGBA,r.webgl.UNSIGNED_BYTE,o),r.webgl.texImage2D(r.webgl.TEXTURE_CUBE_MAP_POSITIVE_Y,0,r.webgl.RGBA,r.webgl.RGBA,r.webgl.UNSIGNED_BYTE,o),r.webgl.texImage2D(r.webgl.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,r.webgl.RGBA,r.webgl.RGBA,r.webgl.UNSIGNED_BYTE,o),r.webgl.texImage2D(r.webgl.TEXTURE_CUBE_MAP_POSITIVE_Z,0,r.webgl.RGBA,r.webgl.RGBA,r.webgl.UNSIGNED_BYTE,o),r.webgl.texImage2D(r.webgl.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,r.webgl.RGBA,r.webgl.RGBA,r.webgl.UNSIGNED_BYTE,o),r.webgl.generateMipmap(r.webgl.TEXTURE_CUBE_MAP),r.webgl.texParameteri(r.webgl.TEXTURE_CUBE_MAP,r.webgl.TEXTURE_MIN_FILTER,r.webgl.LINEAR_MIPMAP_LINEAR),r.engine.textureLoaded(Gt(r)),r.engine.addOnResourcesLoadedListener(function(){null!=r.object&&setTimeout(function(){r.generate()},1e3)}),r._camera=new it(r.engine),r._camera.fieldOfViewRad=r.engine.camera.fieldOfViewRad,r._camera.range=r.engine.camera.range,r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Nt(e,t)}(u,Ft),function(e,t,i){t&&Ut(e.prototype,t),i&&Ut(e,i)}(u,[{key:"generate",value:function(){this.object.updateMatrixes(),this.object.update(),this._camera.position=this.object.position.copy(),this.object.verticalAlign||this._camera.position.move(0,-(this.object.size.current.max.y-this.object.size.current.min.y)/2,0),this._camera.setRotation(0,270,0);var e=this.engine.captureFrame(this._camera,{background:this._background,width:this._quality,height:this._quality,imageAlpha:this._reflectionAlpha,noDrawObjects:[this.object]});this._camera.setRotation(0,90,0);var t=this.engine.captureFrame(this._camera,{background:this._background,width:this._quality,height:this._quality,imageAlpha:this._reflectionAlpha,noDrawObjects:[this.object]});this._camera.setRotation(-90,0,0);var i=this.engine.captureFrame(this._camera,{background:this._background,width:this._quality,height:this._quality,imageAlpha:this._reflectionAlpha,noDrawObjects:[this.object]});this._camera.setRotation(90,0,0);var n=this.engine.captureFrame(this._camera,{background:this._background,width:this._quality,height:this._quality,imageAlpha:this._reflectionAlpha,noDrawObjects:[this.object]});this._camera.setRotation(0,0,0);var r=this.engine.captureFrame(this._camera,{background:this._background,width:this._quality,height:this._quality,imageAlpha:this._reflectionAlpha,noDrawObjects:[this.object]});this._camera.setRotation(0,180,0);var o=this.engine.captureFrame(this._camera,{background:this._background,width:this._quality,height:this._quality,imageAlpha:this._reflectionAlpha,noDrawObjects:[this.object]});if(this.setLoadedImages(e,t,n,i,r,o),Yt++,Ht.length==Yt){for(var s=0;s<Ht.length;s++)Ht[s].generate();this.engine.appendCanvas(),this.engine.status="Drawing"}}},{key:"bindCubeTexture",value:function(){this.engine.webgl.activeTexture(this.engine.webgl.TEXTURE0+this.textureBlockLocation),this.webglTexture=this.webgl.createTexture(),this.webgl.bindTexture(this.webgl.TEXTURE_CUBE_MAP,this.webglTexture),this.webgl.texImage2D(this.webgl.TEXTURE_CUBE_MAP_POSITIVE_X,0,this.webgl.RGBA,this.webgl.RGBA,this.webgl.UNSIGNED_BYTE,this.textures.positiveX),this.webgl.texImage2D(this.webgl.TEXTURE_CUBE_MAP_NEGATIVE_X,0,this.webgl.RGBA,this.webgl.RGBA,this.webgl.UNSIGNED_BYTE,this.textures.negativeX),this.webgl.texImage2D(this.webgl.TEXTURE_CUBE_MAP_POSITIVE_Y,0,this.webgl.RGBA,this.webgl.RGBA,this.webgl.UNSIGNED_BYTE,this.textures.positiveY),this.webgl.texImage2D(this.webgl.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,this.webgl.RGBA,this.webgl.RGBA,this.webgl.UNSIGNED_BYTE,this.textures.negativeY),this.webgl.texImage2D(this.webgl.TEXTURE_CUBE_MAP_POSITIVE_Z,0,this.webgl.RGBA,this.webgl.RGBA,this.webgl.UNSIGNED_BYTE,this.textures.positiveZ),this.webgl.texImage2D(this.webgl.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,this.webgl.RGBA,this.webgl.RGBA,this.webgl.UNSIGNED_BYTE,this.textures.negativeZ),this.webgl.generateMipmap(this.webgl.TEXTURE_CUBE_MAP),this.webgl.texParameteri(this.webgl.TEXTURE_CUBE_MAP,this.webgl.TEXTURE_MIN_FILTER,this.webgl.LINEAR_MIPMAP_LINEAR),this.loaded=!0}},{key:"object",get:function(){return this._object},set:function(e){e.updateMatrixes(),e.update(),this._object=e,this.engine.resourcesLoaded&&this.generate()}}]),u}();function Wt(e){return(Wt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function qt(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Zt(e){return(Zt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Jt(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Kt(e,t){return(Kt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Qt=function(e){function i(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),function(e,t,i){t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i}(Jt(t=function(e,t){return!t||"object"!==Wt(t)&&"function"!=typeof t?Jt(e):t}(this,Zt(i).call(this,e))),"_drawingMode",void 0),t._drawingMode=t.webgl.TRIANGLES,t.hidden=!0,t.name="Just object :)",t}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Kt(e,t)}(i,Ke),function(e,t,i){t&&qt(e.prototype,t),i&&qt(e,i)}(i,[{key:"setDrawingMode",value:function(e){switch(e){case"TRIANGLES":case"DEFAULT":this._drawingMode=this.webgl.TRIANGLES;break;case"TRIANGLE_FAN":case"FAN":this._drawingMode=this.webgl.TRIANGLE_FAN;break;case"STRIP":case"TRIANGLE_STRIP":this.webgl.TRIANGLE_STRIP;break;default:throw Error("Wrong drawing mode. See WebGL drawing mods.")}}},{key:"compile",value:function(e){var g=this,d=[],b=[],m=[],t=e.split("\n"),v={x:[0,0],y:[0,0],z:[0,0]};t.forEach(function(e){for(var t=e.split(" "),i=t.length;i--;)""!=t[i]&&"\r"!=t[i]||t.splice(i,1);if("v"==t[0]){var n=parseFloat(t[1]),r=parseFloat(t[2]),o=parseFloat(t[3]);v.x[1]<n&&(v.x[1]=n),v.y[1]<r&&(v.y[1]=r),v.z[1]<o&&(v.z[1]=o),v.x[0]>n&&(v.x[0]=n),v.y[0]>r&&(v.y[0]=r),v.z[0]>o&&(v.z[0]=o),d.push([n,r,o])}else if("vn"==t[0])m.push([Number(t[1]),parseFloat(t[2]),parseFloat(t[3])]);else if("vt"==t[0])b.push([parseFloat(t[1]),parseFloat(t[2])]);else if("f"==t[0]){var s=[t[1],t[2],t[3]];if(3<t.length-1)for(var a=4;a<t.length;a++)s.push(t[a-3]),s.push(t[a-1]),s.push(t[a]);for(var u=0;u<s.length;u++){var h=s[u].split("/").map(function(e){return Number(e)}),l=h[0];l<=0&&(l=d.length+l+1);var c=h[1];c<0&&(c=b.length+c+1);var f=h[2];f<0&&(f=m.length+f+1),d[l-1].forEach(function(e){g.vertexes.push(e)}),0!=c&&null!=b[c-1]?b[c-1].forEach(function(e){g.textureCoordinates.push(e)}):(g.textureCoordinates.push(1),g.textureCoordinates.push(1)),null!=h[2]?m[f-1].forEach(function(e){g.normals.push(e)}):g.normals.push(1,1,1)}}}),this.vertexesBuffer=this.webgl.createBuffer(),this.webgl.bindBuffer(this.webgl.ARRAY_BUFFER,this.vertexesBuffer),this.webgl.bufferData(this.webgl.ARRAY_BUFFER,new Float32Array(this.vertexes),this.webgl.STATIC_DRAW),this.textureCoordinatesBuffer=this.webgl.createBuffer(),this.webgl.bindBuffer(this.webgl.ARRAY_BUFFER,this.textureCoordinatesBuffer),this.webgl.bufferData(this.webgl.ARRAY_BUFFER,new Float32Array(this.textureCoordinates),this.webgl.STATIC_DRAW),this.normalsBuffer=this.webgl.createBuffer(),this.webgl.bindBuffer(this.webgl.ARRAY_BUFFER,this.normalsBuffer),this.webgl.bufferData(this.webgl.ARRAY_BUFFER,new Float32Array(this.normals),this.webgl.STATIC_DRAW),this.maxBaseSize.set(v.x[0],v.y[0],v.z[0]),this.minBaseSize.set(v.x[1],v.y[1],v.z[1]),this.maxSize.set(v.x[0],v.y[0],v.z[0]),this.minSize.set(v.x[1],v.y[1],v.z[1]),this.maxSize.scale(this.scaling.x,this.scaling.y,this.scaling.z),this.minSize.scale(this.scaling.x,this.scaling.y,this.scaling.z),this.collisionBox.maxPoint=this.maxBaseSize,this.collisionBox.minPoint=this.minBaseSize,this.engine.objectLoaded(this),this.hidden=!1}},{key:"onload",value:function(){}},{key:"loadFromObj",value:function(e){var t=this,i=new XMLHttpRequest;i.open("GET",e),i.onreadystatechange=function(){4==i.readyState&&(t.compile(i.responseText),t.onload())},i.send()}},{key:"useMaterial",value:function(e){var t=this;e.defaultDraw=this.draw,(e.object=this).draw=function(){e.drawObject(t)}}},{key:"drawingMode",set:function(e){this._drawingMode=e},get:function(){return this._drawingMode}}]),i}();function $t(e){return($t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ei(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ti(e){return(ti=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ii(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ni(e,t){return(ni=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ri(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var oi=function(e){function i(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),ri(ii(t=function(e,t){return!t||"object"!==$t(t)&&"function"!=typeof t?ii(e):t}(this,ti(i).call(this,e))),"width",100),ri(ii(t),"height",100),ri(ii(t),"name","Just a rect :)"),t.vertexes=[0,0,0,100,100,0,0,100,0,100,100,0,0,0,0,100,0,0],t.textureCoordinates=[0,1,1,0,0,0,1,0,0,1,1,1],t.normals=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1],t.shaderProgram=t.engine.shaders.default,t.vertexesBuffer=t.webgl.createBuffer(),t.webgl.bindBuffer(t.webgl.ARRAY_BUFFER,t.vertexesBuffer),t.webgl.bufferData(t.webgl.ARRAY_BUFFER,new Float32Array(t.vertexes),t.webgl.STATIC_DRAW),t.textureCoordinatesBuffer=t.webgl.createBuffer(),t.webgl.bindBuffer(t.webgl.ARRAY_BUFFER,t.textureCoordinatesBuffer),t.webgl.bufferData(t.webgl.ARRAY_BUFFER,new Float32Array(t.textureCoordinates),t.webgl.STATIC_DRAW),t.normalsBuffer=t.webgl.createBuffer(),t.webgl.bindBuffer(t.webgl.ARRAY_BUFFER,t.normalsBuffer),t.webgl.bufferData(t.webgl.ARRAY_BUFFER,new Float32Array(t.normals),t.webgl.STATIC_DRAW),t.collisionBox.maxPoint.set(100,100,0),t.collisionBox.minPoint.set(0,0,0),t.maxBaseSize.set(100,100,0),t.maxSize=t.maxBaseSize,t.engine.objectLoaded(ii(t)),t}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ni(e,t)}(i,Ke),function(e,t,i){t&&ei(e.prototype,t),i&&ei(e,i)}(i,[{key:"scale",value:function(e,t){this.scaling.set(e,t,1),this.maxSize.set(this.maxBaseSize.x*e,this.maxBaseSize.y*t,0),this.minSize.set(this.minBaseSize.x*e,this.minBaseSize.y*t,0),"center"==this.rotationPointPos&&this.rotationPoint.set(this.minSize.x+(this.maxSize.x-this.minSize.x)/2,this.minSize.y+(this.maxSize.y-this.minSize.y)/2,this.minSize.z+(this.maxSize.z-this.minSize.z)/2)}},{key:"setSize",value:function(e,t){this.width=e,this.height=t,this.scale(this.width/100,this.height/100)}},{key:"setCellSize",value:function(e,t){this.setTextureRepeating(this.width/e,this.height/t)}},{key:"setTextureRepeating",value:function(e,t){this.textureCoordinates=[0,t,e,0,0,0,e,0,0,t,e,t],this.webgl.bindBuffer(this.webgl.ARRAY_BUFFER,this.textureCoordinatesBuffer),this.webgl.bufferData(this.webgl.ARRAY_BUFFER,new Float32Array(this.textureCoordinates),this.webgl.STATIC_DRAW)}}]),i}();function si(e){return(si="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ai(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ui(e){return(ui=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function hi(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function li(e,t){return(li=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ci=function(e){function i(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),(t=function(e,t){return!t||"object"!==si(t)&&"function"!=typeof t?hi(e):t}(this,ui(i).call(this,e))).name="Just skybox :)",t.webgl=e.webgl,t.vertexes=[-1,-1,1,-1,-1,1,-1,1,1,-1,1,1],t.shaderProgram=e.shaders.skybox,t.texture=e.noTexture,t.vertexesBuffer=t.webgl.createBuffer(),t.webgl.bindBuffer(t.webgl.ARRAY_BUFFER,t.vertexesBuffer),t.webgl.bufferData(t.webgl.ARRAY_BUFFER,new Float32Array(t.vertexes),t.webgl.STATIC_DRAW),t.engine.objectLoaded(hi(t)),t}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&li(e,t)}(i,$e),function(e,t,i){t&&ai(e.prototype,t),i&&ai(e,i)}(i,[{key:"updateMatrixes",value:function(){var e=z(this.engine.camera.fieldOfViewRad,this.engine.width,this.engine.height,1,this.engine.camera.range);e=Z(e=Z(e,this.engine.camera.inverseRotationMatrix),q(this.rotation.x,this.rotation.y,this.rotation.z)),this.matrix=$(e)}},{key:"update",value:function(){}},{key:"draw",value:function(){this.shaderProgram?(this.shaderProgram.use(),this.engine.webgl.enableVertexAttribArray(this.shaderProgram.positionLocation),this.engine.webgl.bindBuffer(this.engine.webgl.ARRAY_BUFFER,this.vertexesBuffer),this.engine.webgl.vertexAttribPointer(this.shaderProgram.positionLocation,2,this.engine.webgl.FLOAT,!1,0,0),this.engine.webgl.uniform1i(this.shaderProgram.textureLocation,this.texture.textureBlockLocation),this.engine.webgl.uniformMatrix4fv(this.shaderProgram.matrixLocation,!1,this.matrix),this.engine.webgl.drawArrays(this.engine.webgl.TRIANGLES,0,this.vertexes.length/2),this.engine.shaders.default.use()):new Ce("Shader program is not set.")}}]),i}();function fi(e){return(fi="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function gi(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function di(e){return(di=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function bi(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function mi(e,t){return(mi=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function vi(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var _i=function(e){function i(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),vi(bi(t=function(e,t){return!t||"object"!==fi(t)&&"function"!=typeof t?bi(e):t}(this,di(i).call(this,e))),"cellSize",void 0),vi(bi(t),"movingMatrix",[]),t.shaderProgram=t.engine.shaders.grid,t.cellSize=[1e3,1e3],t.name="Just a gird :)",t}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&mi(e,t)}(i,oi),function(e,t,i){t&&gi(e.prototype,t),i&&gi(e,i)}(i,[{key:"draw",value:function(){this.shaderProgram.use(),this.engine.webgl.texParameteri(this.engine.webgl.TEXTURE_2D,this.engine.shaders.extensions.anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,16),this.engine.webgl.enableVertexAttribArray(this.shaderProgram.positionLocation),this.engine.webgl.bindBuffer(this.engine.webgl.ARRAY_BUFFER,this.vertexesBuffer),this.engine.webgl.vertexAttribPointer(this.shaderProgram.positionLocation,3,this.engine.webgl.FLOAT,!1,0,0),this.engine.webgl.enableVertexAttribArray(this.shaderProgram.texcoordLocation),this.engine.webgl.bindBuffer(this.engine.webgl.ARRAY_BUFFER,this.textureCoordinatesBuffer),this.engine.webgl.vertexAttribPointer(this.shaderProgram.texcoordLocation,2,this.engine.webgl.FLOAT,!1,0,0),this.engine.webgl.uniform1i(this.shaderProgram.textureLocation,this.texture.textureBlockLocation),this.engine.webgl.uniformMatrix4fv(this.shaderProgram.matrixLocation,!1,this.matrix),this.engine.webgl.uniform2fv(this.shaderProgram.movingLocation,this.movingMatrix),this.engine.webgl.uniform2fv(this.shaderProgram.cellSizeLocation,this.cellSize),this.engine.webgl.drawArrays(this.engine.webgl.TRIANGLES,0,this.vertexes.length/3)}},{key:"updateMatrixes",value:function(){var e=$(D(this.rotationPoint.x,this.rotationPoint.y,this.rotationPoint.z));e=Z(e,D(this.position.x,this.position.y,this.position.z));var t=q(this.rotation.x,this.rotation.y,this.rotation.z);e=Z(e=Z(e=Z(e=Z(e,t),D(this.rotationPoint.x,this.rotationPoint.y,this.rotationPoint.z)),D(-this.minSize.x-(this.maxSize.x-this.minSize.x)/2,-this.minSize.y-(this.maxSize.y-this.minSize.y)/2,-this.minSize.z-(this.maxSize.z-this.minSize.z)/2)),W(this.scaling.x,this.scaling.y,this.scaling.z)),this.worldMatrix=e,this.rotationMatrix=t}},{key:"update",value:function(){var e=z(this.engine.camera.fieldOfViewRad,this.engine.width,this.engine.height,1,this.engine.camera.range),t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];e=Z(e=Z(e,$(t=Z(t=Z(t,D(0,this.engine.camera.position.y,0)),this.engine.camera.rotationMatrix))),this.worldMatrix),this.movingMatrix=[this.engine.camera.position.x,this.engine.camera.position.z],this.matrix=e}},{key:"setCellSize",value:function(e,t){this.cellSize=[e,t],this.setTextureRepeating(this.width/e,this.height/t)}},{key:"setSize",value:function(e,t){this.width=e,this.height=t,this.vertexes=[0,0,0,e,t,0,0,t,0,e,t,0,0,0,0,e,0,0],this.maxSize.set(e,t,0),this.minSize.set(0,0,0),this.setCellSize(this.cellSize[0],this.cellSize[1]),this.webgl.bindBuffer(this.webgl.ARRAY_BUFFER,this.vertexesBuffer),this.webgl.bufferData(this.webgl.ARRAY_BUFFER,new Float32Array(this.vertexes),this.webgl.STATIC_DRAW)}}]),i}();function wi(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function yi(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var pi=0,xi=function(){function t(e){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),yi(this,"engine",void 0),yi(this,"_position",new g(0,0,0)),yi(this,"_range",2e3),yi(this,"_color",new Uint8Array([255,255,255,255])),yi(this,"_index",-1),yi(this,"_on",!1),yi(this,"_positionsWritten",!1),yi(this,"_rangeWritten",!1),28<++pi)throw new Error("There are can be only 28 lights. Sorry :(");this.engine=e,this._range=2e3,this._on=!1}return function(e,t,i){t&&wi(e.prototype,t),i&&wi(e,i)}(t,[{key:"setPosition",value:function(e,t,i){e.constructor!==g?e.constructor!==Array?(this._position.set(e,t,i),this._on&&!this._positionsWritten?(this.engine.lightsPositions.push(e),this.engine.lightsPositions.push(t),this.engine.lightsPositions.push(i),this._positionsWritten=!0):this._on&&(this.engine.lightsPositions[3*this._index+0]=e,this.engine.lightsPositions[3*this._index+1]=t,this.engine.lightsPositions[3*this._index+2]=i)):this._position.set(e[0],e[1],e[2]):this._position=e}},{key:"move",value:function(e,t,i){this.position.move(e,t,i)}},{key:"setRange",value:function(e){this.range=e}},{key:"setColorRGBA",value:function(e,t,i,n){this._color=new Uint8Array([e,t,i,n])}},{key:"on",value:function(){this._index=this.engine.lights.length,this._on=!0,this.engine.lights.push(this),this.position=this._position,this.range=this._range}},{key:"off",value:function(){var e=this._index;this.engine.lights.splice(e,1),this.engine.lightsPositions.splice(3*e+0,3),this.engine.lightsRanges.splice(e,1),this._positionsWritten=!1,this._rangeWritten=!1}},{key:"range",set:function(e){this._range=e,this._on&&!this._rangeWritten?(this.engine.lightsRanges.push(e),this._rangeWritten=!0):this._on&&(this.engine.lightsRanges[this._index]=e)},get:function(){return this._range}},{key:"position",set:function(e){this._position=e,this._on&&!this._positionsWritten?(this.engine.lightsPositions.push(e.x),this.engine.lightsPositions.push(e.y),this.engine.lightsPositions.push(e.z),this._positionsWritten=!0):this._on&&(this.engine.lightsPositions[3*this._index+0]=e.x,this.engine.lightsPositions[3*this._index+1]=e.y,this.engine.lightsPositions[3*this._index+2]=e.z)},get:function(){return this._position}}]),t}();function Ei(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Ti(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var Ri=function(){function i(e,t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),Ti(this,"defaultDraw",null),Ti(this,"engine",void 0),Ti(this,"_object",void 0),Ti(this,"webgl",void 0),Ti(this,"shaderProgram",null),this.engine=e,this._object=t||null,this.webgl=e.webgl}return function(e,t,i){t&&Ei(e.prototype,t),i&&Ei(e,i)}(i,[{key:"setShaderProgram",value:function(e){this.shaderProgram=e}},{key:"drawObject",value:function(e){throw new Error("Method not implemented.")}},{key:"object",get:function(){return this._object},set:function(e){null!=(this._object=e)&&e.texture instanceof Vt&&((e.texture.object=e).update(),e.updateMatrixes())}}]),i}();function Ai(e){return(Ai="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Pi(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Si(e,t){return!t||"object"!==Ai(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function Bi(e){return(Bi=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ki(e,t){return(ki=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Li=function(e){function n(e,t){var i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),(i=Si(this,Bi(n).call(this,e,t))).shaderProgram=e.shaders.reflection,i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ki(e,t)}(n,Ri),function(e,t,i){t&&Pi(e.prototype,t),i&&Pi(e,i)}(n,[{key:"drawObject",value:function(e){e.texture.loaded&&e.loaded&&(this.shaderProgram.use(),this.webgl.uniformMatrix4fv(this.shaderProgram.cameraLocation,!1,this.engine.camera.matrix),this.webgl.uniform3fv(this.shaderProgram.lightPositionsLocation,this.engine.lightsPositions),this.webgl.uniform1fv(this.shaderProgram.lightRangesLocation,this.engine.lightsRanges),this.webgl.uniform1i(this.shaderProgram.lightsCountLocation,this.engine.lights.length),this.webgl.uniform1f(this.shaderProgram.lightMinValueLocation,this.engine.globalLightMinValue),this.engine.webgl.enableVertexAttribArray(this.shaderProgram.positionLocation),this.engine.webgl.bindBuffer(this.engine.webgl.ARRAY_BUFFER,e.vertexesBuffer),this.engine.webgl.vertexAttribPointer(this.shaderProgram.positionLocation,3,this.engine.webgl.FLOAT,!1,0,0),this.engine.webgl.enableVertexAttribArray(this.shaderProgram.normalLocation),this.engine.webgl.bindBuffer(this.engine.webgl.ARRAY_BUFFER,e.normalsBuffer),this.engine.webgl.vertexAttribPointer(this.shaderProgram.normalLocation,3,this.engine.webgl.FLOAT,!1,0,0),this.engine.webgl.uniform1i(this.shaderProgram.textureLocation,e.texture.textureBlockLocation),this.engine.webgl.uniformMatrix4fv(this.shaderProgram.matrixLocation,!1,e.matrix),this.engine.webgl.uniformMatrix4fv(this.shaderProgram.worldMatrixLocation,!1,e.worldMatrix),this.engine.webgl.uniformMatrix4fv(this.shaderProgram.rotationMatrixLocation,!1,e.rotationMatrix),this.engine.webgl.uniform3fv(this.shaderProgram.worldCameraPositionLocation,new Float32Array(this.engine.camera.position.toArray())),this.engine.webgl.drawArrays(this.engine.webgl.TRIANGLES,0,e.vertexes.length/3))}}]),n}();function Ci(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Oi(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var Ii=function(){function u(e){var t,i=this,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:60,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:.1;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u),Oi(this,"playing",!1),Oi(this,"audios",void 0),Oi(this,"_audioCount",void 0),Oi(this,"_playableAudioIndex",0),Oi(this,"_delay",100),Oi(this,"_canBePlayed",!0),Oi(this,"_canBePlayedInterval",null),Oi(this,"_loopInterval",-1),Oi(this,"_volume",.1),this.audios=[],this._audioCount=n,e instanceof Array){if(!(e instanceof Array))return;t=e}else{t=[];for(var o=0;o<n;o++)t.push(e)}for(var s=0,a=0;a<this._audioCount;a++)this.audios.push(new Audio(t[s])),this.audios[a].volume=r,++s===e.length&&(s=0);this._canBePlayed=!0,this._canBePlayedInterval=Number(setInterval(function(){i._canBePlayed=!0},this._delay)),this.playing=!1}return function(e,t,i){t&&Ci(e.prototype,t),i&&Ci(e,i)}(u,[{key:"play",value:function(){this._canBePlayed&&(this.audios[this._playableAudioIndex].play(),this._playableAudioIndex++,this._playableAudioIndex==this._audioCount&&(this._playableAudioIndex=0),this._canBePlayed=!1)}},{key:"playLoop",value:function(){var e=this;clearInterval(this._loopInterval),this._loopInterval=Number(setInterval(function(){e.play()},this._delay)),this.playing=!0}},{key:"playLoopRandom",value:function(){var e=this;clearInterval(this._loopInterval),this._loopInterval=Number(setInterval(function(){e._canBePlayed&&(e.audios[e._playableAudioIndex].play(),e._playableAudioIndex=Math.floor(Math.random()*e._audioCount),e._playableAudioIndex==e._audioCount&&(e._playableAudioIndex=0),e._canBePlayed=!1)},this._delay)),this.playing=!0}},{key:"stop",value:function(){clearInterval(this._loopInterval),this._canBePlayed=!1,this.playing=!1;for(var e=0;e<this.audios.length;e++){var t=this.audios[e];t.pause(),t.currentTime=0}}},{key:"volume",set:function(e){for(var t=0;t<this._audioCount;t++)this.audios[t].volume=e},get:function(){return this._volume}},{key:"delay",set:function(e){var t=this;this._delay=e,clearInterval(this._canBePlayedInterval),this._canBePlayedInterval=Number(setInterval(function(){t._canBePlayed=!0},this._delay))},get:function(){return this._delay}}]),u}();i.d(t,"Engine",function(){return Ye}),i.d(t,"Camera",function(){return it}),i.d(t,"Controls",function(){return st}),i.d(t,"UI",function(){return Tt}),i.d(t,"Debugger",function(){return kt}),i.d(t,"Texture",function(){return je}),i.d(t,"ColorTexture",function(){return Ge}),i.d(t,"SimpleTexture",function(){return bt}),i.d(t,"CubeTexture",function(){return Ft}),i.d(t,"ReflectionTexture",function(){return Vt}),i.d(t,"Entity",function(){return Ke}),i.d(t,"CollisionBox",function(){return Qe}),i.d(t,"Object",function(){return Qt}),i.d(t,"Rect",function(){return oi}),i.d(t,"Skybox",function(){return ci}),i.d(t,"Grid",function(){return _i}),i.d(t,"Light",function(){return xi}),i.d(t,"Material",function(){return Ri}),i.d(t,"Glass",function(){return Li}),i.d(t,"Sound",function(){return Ii}),i.d(t,"Mathematics",function(){return n}),i.d(t,"Vector3",function(){return r}),i.d(t,"Matrixes4",function(){return s}),i.d(t,"Vector2",function(){return o})}],r.c=n,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)r.d(i,n,function(e){return t[e]}.bind(null,n));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/dist",r(r.s=0);function r(e){if(n[e])return n[e].exports;var t=n[e]={i:e,l:!1,exports:{}};return i[e].call(t.exports,t,t.exports,r),t.l=!0,t.exports}var i,n});